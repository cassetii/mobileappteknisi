<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1e3c72">
    <title>Nala Teknisi App</title>
    <link rel="manifest" href="manifest.json">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #f0f2f5;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Login Screen */
        .login-screen {
            min-height: 100vh;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .login-screen.hidden { display: none; }
        .login-logo { font-size: 4em; margin-bottom: 20px; }
        .login-title { color: white; font-size: 1.8em; margin-bottom: 10px; }
        .login-subtitle { color: rgba(255,255,255,0.8); margin-bottom: 40px; }

        .login-form {
            background: white;
            padding: 30px;
            border-radius: 20px;
            width: 100%;
            max-width: 350px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }

        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; }

        .form-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .form-input:focus { outline: none; border-color: #667eea; }
        .pin-input { letter-spacing: 15px; text-align: center; font-size: 1.5em; font-weight: bold; }

        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:active { transform: scale(0.98); }

        /* Main App */
        .app-container { display: none; min-height: 100vh; padding-bottom: 80px; }
        .app-container.active { display: block; }

        /* Header */
        .app-header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 20px;
            padding-top: 40px;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .user-info { display: flex; align-items: center; gap: 12px; }

        .user-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2em;
        }

        .user-name { font-size: 1.1em; font-weight: 600; }
        .user-role { font-size: 0.85em; opacity: 0.8; }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 10px 15px;
            border-radius: 10px;
            font-size: 0.9em;
            cursor: pointer;
        }

        .date-display {
            text-align: center;
            padding: 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
        }

        .date-display .day { font-size: 1.5em; font-weight: bold; }
        .date-display .full-date { font-size: 0.9em; opacity: 0.9; }

        /* Tab Content */
        .tab-content { display: none; padding: 20px; }
        .tab-content.active { display: block; }

        /* Cards */
        .card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .card h4 {
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Attendance Styles */
        .attendance-card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .attendance-status { text-align: center; margin-bottom: 25px; }
        .status-icon { font-size: 3em; margin-bottom: 10px; }
        .status-text { font-size: 1.2em; font-weight: 600; color: #333; }
        .status-time { color: #666; margin-top: 5px; }

        .attendance-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }

        .attendance-btn {
            padding: 20px;
            border: none;
            border-radius: 15px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }

        .attendance-btn .icon { font-size: 1.5em; }
        .attendance-btn.check-in { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; }
        .attendance-btn.check-out { background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%); color: white; }
        .attendance-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .location-info {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            text-align: center;
            font-size: 0.9em;
            color: #666;
        }

        .history-item {
            background: white;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .history-date {
            font-weight: 600;
            color: #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .history-badge {
            font-size: 0.75em;
            padding: 4px 10px;
            border-radius: 20px;
            font-weight: 500;
        }

        .history-badge.present { background: #d4edda; color: #155724; }
        .history-badge.late { background: #fff3cd; color: #856404; }

        .history-details {
            display: flex;
            gap: 20px;
            margin-top: 8px;
            font-size: 0.9em;
            color: #666;
        }

        /* ==========================================
           GAJI STYLES - KPI Based
           ========================================== */
        .gaji-summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .gaji-summary-card h3 {
            margin-bottom: 5px;
            font-size: 0.95em;
            opacity: 0.9;
        }

        .gaji-total {
            font-size: 2.2em;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .gaji-period {
            font-size: 0.85em;
            opacity: 0.85;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* KPI Achievement Banner */
        .kpi-achievement-banner {
            background: rgba(255,255,255,0.15);
            border-radius: 12px;
            padding: 15px;
            margin-top: 15px;
        }

        .kpi-achievement-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .kpi-achievement-label { font-size: 0.85em; opacity: 0.9; }

        .kpi-achievement-value {
            font-size: 1.5em;
            font-weight: bold;
        }

        .kpi-progress-bar {
            height: 8px;
            background: rgba(255,255,255,0.3);
            border-radius: 4px;
            overflow: hidden;
        }

        .kpi-progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .kpi-progress-fill.green { background: #38ef7d; }
        .kpi-progress-fill.yellow { background: #ffc107; }
        .kpi-progress-fill.red { background: #f44336; }

        .kpi-achievement-note {
            font-size: 0.8em;
            margin-top: 10px;
            opacity: 0.85;
            text-align: center;
        }

        /* Gaji Grid */
        .gaji-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .gaji-grid-item {
            background: rgba(255,255,255,0.15);
            padding: 12px;
            border-radius: 10px;
            text-align: center;
        }

        .gaji-grid-item .value { font-size: 1.1em; font-weight: bold; }
        .gaji-grid-item .label { font-size: 0.75em; opacity: 0.9; margin-top: 4px; }

        /* Breakdown rows */
        .gaji-breakdown-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .gaji-breakdown-row:last-child { border-bottom: none; }

        .gaji-breakdown-row.total {
            border-top: 2px solid #e0e0e0;
            margin-top: 10px;
            padding-top: 15px;
            font-weight: bold;
            font-size: 1.1em;
        }

        .gaji-label {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #555;
        }

        .gaji-label .icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1em;
        }

        .gaji-label .icon.salary { background: #e3f2fd; }
        .gaji-label .icon.meal { background: #fff3e0; }
        .gaji-label .icon.overtime { background: #e8f5e9; }
        .gaji-label .icon.deduction { background: #ffebee; }
        .gaji-label .icon.kpi { background: #f3e5f5; }

        .gaji-value { font-weight: 600; color: #333; }
        .gaji-value.positive { color: #2e7d32; }
        .gaji-value.negative { color: #c62828; }

        .gaji-detail { font-size: 0.8em; color: #999; margin-top: 2px; }

        /* Trend Table */
        .trend-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85em;
        }

        .trend-table th {
            background: #f8f9fa;
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            color: #555;
            border-bottom: 2px solid #e0e0e0;
        }

        .trend-table td {
            padding: 12px 8px;
            border-bottom: 1px solid #f0f0f0;
        }

        .trend-table tr:last-child td { border-bottom: none; }

        .trend-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 500;
        }

        .trend-status.achieved { background: #d4edda; color: #155724; }
        .trend-status.below { background: #f8d7da; color: #721c24; }

        .trend-value { font-weight: 600; }
        .trend-value.positive { color: #2e7d32; }
        .trend-value.negative { color: #c62828; }

        /* AI Chat */
        .chat-container {
            background: white;
            border-radius: 20px;
            height: calc(100vh - 280px);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-messages { flex: 1; overflow-y: auto; padding: 20px; }
        .chat-message { margin-bottom: 15px; display: flex; flex-direction: column; }
        .chat-message.user { align-items: flex-end; }
        .chat-message.ai { align-items: flex-start; }

        .message-bubble {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 18px;
            font-size: 0.95em;
            line-height: 1.4;
            white-space: pre-wrap;
        }

        .chat-message.user .message-bubble {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-bottom-right-radius: 5px;
        }

        .chat-message.ai .message-bubble {
            background: #f0f2f5;
            color: #333;
            border-bottom-left-radius: 5px;
        }

        .message-time { font-size: 0.75em; color: #999; margin-top: 5px; }

        .chat-input-container {
            display: flex;
            padding: 15px;
            border-top: 1px solid #eee;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 12px 18px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 1em;
            outline: none;
        }

        .chat-input:focus { border-color: #667eea; }

        .send-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-size: 1.2em;
            cursor: pointer;
        }

        .typing-indicator { display: flex; gap: 4px; padding: 10px; }
        .typing-indicator span {
            width: 8px; height: 8px; background: #999; border-radius: 50%;
            animation: typing 1.4s infinite;
        }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 100% { opacity: 0.3; transform: translateY(0); }
            50% { opacity: 1; transform: translateY(-4px); }
        }

        /* Bottom Nav */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            box-shadow: 0 -2px 15px rgba(0,0,0,0.1);
            z-index: 100;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px 12px;
            border: none;
            background: none;
            color: #999;
            font-size: 0.7em;
            cursor: pointer;
            transition: all 0.3s;
        }

        .nav-item .icon { font-size: 1.4em; }
        .nav-item.active { color: #667eea; }

        /* Loading & Toast */
        .loading-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .loading-overlay.active { opacity: 1; visibility: visible; }

        .loading-spinner {
            width: 50px; height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #333;
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 0.9em;
            opacity: 0;
            transition: all 0.3s;
            z-index: 1001;
        }

        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        .toast.success { background: #4caf50; }
        .toast.error { background: #f44336; }
        .toast.warning { background: #ff9800; }

        /* Realtime indicator */
        .realtime-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.8em;
            color: #666;
            margin-bottom: 15px;
        }

        .realtime-dot {
            width: 8px; height: 8px;
            background: #4caf50;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        .empty-state .icon { font-size: 3em; margin-bottom: 15px; opacity: 0.5; }

        /* Info Box */
        .info-box {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 10px;
            padding: 12px 15px;
            font-size: 0.85em;
            color: #856404;
            margin-bottom: 15px;
        }

        .info-box.success {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }

        .info-box.danger {
            background: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }

        /* Jam Kerja & Lembur Styles */
        .work-hours-card {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(17, 153, 142, 0.3);
        }

        .work-hours-card h3 {
            margin-bottom: 15px;
            font-size: 1.1em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .work-summary-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .work-summary-item {
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 12px;
            text-align: center;
        }

        .work-summary-item .value {
            font-size: 1.4em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .work-summary-item .label {
            font-size: 0.8em;
            opacity: 0.9;
        }

        .work-summary-item.highlight {
            background: rgba(255,255,255,0.35);
            grid-column: span 2;
        }

        .work-summary-item.highlight .value {
            font-size: 1.8em;
        }

        /* Detail Table Styles */
        .detail-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8em;
        }

        .detail-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 6px;
            text-align: center;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        .detail-table td {
            padding: 10px 6px;
            border-bottom: 1px solid #f0f0f0;
            text-align: center;
            vertical-align: middle;
        }

        .detail-table tr:nth-child(even) {
            background: #f8f9fa;
        }

        .detail-table tr:hover {
            background: #e8f4fd;
        }

        .detail-table .date-cell {
            text-align: left;
            font-weight: 500;
            white-space: nowrap;
        }

        .detail-table .money {
            color: #2e7d32;
            font-weight: 600;
        }

        .detail-table .overtime-highlight {
            background: #fff3e0;
            color: #e65100;
            font-weight: 600;
        }

        .detail-table tfoot td {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            font-weight: bold;
            padding: 12px 6px;
        }

        .time-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 500;
        }

        .time-badge.normal { background: #e8f5e9; color: #2e7d32; }
        .time-badge.overtime { background: #fff3e0; color: #e65100; }
        .time-badge.late { background: #ffebee; color: #c62828; }

        .scroll-table-container {
            max-height: 400px;
            overflow-y: auto;
            border-radius: 12px;
            border: 1px solid #e0e0e0;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
        <div class="login-logo">üîß</div>
        <h1 class="login-title">Nala Teknisi</h1>
        <p class="login-subtitle">Aplikasi Absensi & KPI</p>

        <div class="login-form">
            <div class="form-group">
                <label>Pilih Nama</label>
                <select class="form-input" id="loginName">
                    <option value="">-- Pilih Nama --</option>
                </select>
            </div>
            <div class="form-group">
                <label>PIN (4 digit)</label>
                <input type="password" class="form-input pin-input" id="loginPin" maxlength="4" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            </div>
            <button class="btn btn-primary" onclick="login()">üîì Masuk</button>
        </div>
    </div>

    <!-- Main App -->
    <div class="app-container" id="appContainer">
        <div class="app-header">
            <div class="header-top">
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">A</div>
                    <div>
                        <div class="user-name" id="userName">Teknisi</div>
                        <div class="user-role">Teknisi AC</div>
                    </div>
                </div>
                <button class="logout-btn" onclick="logout()">Keluar</button>
            </div>
            <div class="date-display">
                <div class="day" id="currentDay">Senin</div>
                <div class="full-date" id="currentDate">1 Januari 2026</div>
            </div>
        </div>

        <!-- Tab: Absensi -->
        <div class="tab-content active" id="tabAbsensi">
            <div class="attendance-card">
                <div class="attendance-status">
                    <div class="status-icon" id="attendanceIcon">üè†</div>
                    <div class="status-text" id="attendanceText">Belum Check In</div>
                    <div class="status-time" id="attendanceTime"></div>
                </div>
                
                <div class="attendance-buttons">
                    <button class="attendance-btn check-in" id="btnCheckIn" onclick="checkIn()">
                        <span class="icon">üìç</span>
                        <span>Check In</span>
                    </button>
                    <button class="attendance-btn check-out" id="btnCheckOut" onclick="checkOut()" disabled>
                        <span class="icon">üèÅ</span>
                        <span>Check Out</span>
                    </button>
                </div>

                <div class="location-info" id="locationInfo">üìç Mengambil lokasi...</div>
            </div>

            <h3 style="margin-bottom: 15px; color: #333;">üìã Riwayat Absensi</h3>
            <div id="attendanceHistory"></div>
        </div>

        <!-- Tab: Gaji (KPI Based) -->
        <div class="tab-content" id="tabGaji">
            <div class="realtime-indicator">
                <div class="realtime-dot"></div>
                <span>Data realtime dari KPI Nala</span>
            </div>

            <!-- DEBUG & TEST BUTTONS -->
            <div class="card" style="background: #fff3e0; border: 2px dashed #ff9800; margin-bottom: 15px;">
                <h4 style="color: #e65100;">üîß Debug & Test Mode</h4>
                <p style="font-size: 0.85em; color: #666; margin-bottom: 15px;">Gunakan tombol ini untuk cek data atau generate sample data testing.</p>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button onclick="debugCheckData()" style="padding: 10px 15px; background: #2196f3; color: white; border: none; border-radius: 8px; cursor: pointer;">
                        üîç Cek Data Firebase
                    </button>
                    <button onclick="generateSampleData()" style="padding: 10px 15px; background: #4caf50; color: white; border: none; border-radius: 8px; cursor: pointer;">
                        ‚ûï Generate Sample Data
                    </button>
                    <button onclick="clearSampleData()" style="padding: 10px 15px; background: #f44336; color: white; border: none; border-radius: 8px; cursor: pointer;">
                        üóëÔ∏è Hapus Sample Data
                    </button>
                </div>
                <div id="debugOutput" style="margin-top: 15px; padding: 10px; background: #333; color: #0f0; font-family: monospace; font-size: 0.8em; border-radius: 8px; max-height: 200px; overflow-y: auto; display: none;"></div>
            </div>

            <div class="gaji-summary-card">
                <h3>üí∞ Total Gaji Bulan Ini</h3>
                <div class="gaji-total" id="gajiTotal">Rp 0</div>
                <div class="gaji-period">
                    <span>üìÖ</span>
                    <span id="gajiPeriod">1 - 31 Januari 2026</span>
                </div>

                <!-- KPI Achievement Banner -->
                <div class="kpi-achievement-banner">
                    <div class="kpi-achievement-header">
                        <span class="kpi-achievement-label">Rata-rata Pencapaian KPI</span>
                        <span class="kpi-achievement-value" id="avgKpiAchievement">0%</span>
                    </div>
                    <div class="kpi-progress-bar">
                        <div class="kpi-progress-fill green" id="avgKpiProgressBar" style="width: 0%"></div>
                    </div>
                    <div class="kpi-achievement-note" id="kpiNote">
                        ‚ö†Ô∏è Gaji & Lembur dihitung berdasarkan pencapaian KPI
                    </div>
                </div>

                <div class="gaji-grid">
                    <div class="gaji-grid-item">
                        <div class="value" id="gajiHariKerja">0</div>
                        <div class="label">Hari Kerja</div>
                    </div>
                    <div class="gaji-grid-item">
                        <div class="value" id="gajiLembur">0 jam</div>
                        <div class="label">Total Lembur</div>
                    </div>
                    <div class="gaji-grid-item">
                        <div class="value" id="gajiTelat">0 mnt</div>
                        <div class="label">Total Telat</div>
                    </div>
                    <div class="gaji-grid-item">
                        <div class="value" id="gajiPotongan">Rp 0</div>
                        <div class="label">Pot. Telat</div>
                    </div>
                </div>
            </div>

            <!-- REKAP JAM KERJA & LEMBUR - DIPINDAH KE ATAS -->
            <div class="work-hours-card">
                <h3>‚è±Ô∏è Rekap Jam Kerja & Pendapatan s/d Hari Ini</h3>
                <div class="work-summary-grid">
                    <div class="work-summary-item">
                        <div class="value" id="totalJamKerja">0j 0m</div>
                        <div class="label">Total Jam Kerja</div>
                    </div>
                    <div class="work-summary-item">
                        <div class="value" id="totalJamLembur">0j 0m</div>
                        <div class="label">Total Jam Lembur</div>
                    </div>
                    <div class="work-summary-item">
                        <div class="value" id="totalGajiPokok">Rp 0</div>
                        <div class="label">Total Gaji Pokok</div>
                    </div>
                    <div class="work-summary-item">
                        <div class="value" id="totalUangMakan">Rp 0</div>
                        <div class="label">Total Uang Makan</div>
                    </div>
                    <div class="work-summary-item">
                        <div class="value" id="totalUangLembur">Rp 0</div>
                        <div class="label">Total Uang Lembur</div>
                    </div>
                    <div class="work-summary-item">
                        <div class="value" id="totalPotonganTelat" style="color: #ffcdd2;">Rp 0</div>
                        <div class="label">Total Potongan</div>
                    </div>
                    <div class="work-summary-item highlight">
                        <div class="value" id="grandTotalSampaiHariIni">Rp 0</div>
                        <div class="label">üí∞ TOTAL GAJI BERSIH s/d Hari Ini</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h4>üìä Rincian Gaji Bulan Ini</h4>
                
                <div class="gaji-breakdown-row">
                    <div class="gaji-label">
                        <div class="icon salary">üíº</div>
                        <div>
                            <div>Gaji Pokok</div>
                            <div class="gaji-detail" id="gajiPokokDetail">Berdasarkan KPI</div>
                        </div>
                    </div>
                    <div class="gaji-value positive" id="gajiPokokValue">Rp 0</div>
                </div>

                <div class="gaji-breakdown-row">
                    <div class="gaji-label">
                        <div class="icon meal">üçΩÔ∏è</div>
                        <div>
                            <div>Uang Makan</div>
                            <div class="gaji-detail" id="gajiMakanDetail">Tetap per hari hadir</div>
                        </div>
                    </div>
                    <div class="gaji-value positive" id="gajiMakanValue">Rp 0</div>
                </div>

                <div class="gaji-breakdown-row">
                    <div class="gaji-label">
                        <div class="icon overtime">‚è∞</div>
                        <div>
                            <div>Uang Lembur</div>
                            <div class="gaji-detail" id="gajiLemburDetail">Berdasarkan KPI</div>
                        </div>
                    </div>
                    <div class="gaji-value positive" id="gajiLemburValue">Rp 0</div>
                </div>

                <div class="gaji-breakdown-row">
                    <div class="gaji-label">
                        <div class="icon deduction">‚ö†Ô∏è</div>
                        <div>
                            <div>Potongan Terlambat</div>
                            <div class="gaji-detail" id="gajiPotonganDetail">Rp 7.500/30 menit</div>
                        </div>
                    </div>
                    <div class="gaji-value negative" id="gajiPotonganValue">- Rp 0</div>
                </div>

                <div class="gaji-breakdown-row total">
                    <div class="gaji-label"><strong>TOTAL GAJI</strong></div>
                    <div class="gaji-value" style="color: #1e3c72; font-size: 1.2em;" id="gajiTotalBreakdown">Rp 0</div>
                </div>
            </div>

            <div class="card">
                <h4>üìÖ Detail Gaji Per Hari</h4>
                <div style="overflow-x: auto;">
                    <table class="trend-table" id="gajiDailyTable">
                        <thead>
                            <tr>
                                <th>Tanggal</th>
                                <th>KPI</th>
                                <th>%</th>
                                <th>Gaji</th>
                            </tr>
                        </thead>
                        <tbody id="gajiDailyBody"></tbody>
                    </table>
                </div>
                <div class="empty-state" id="gajiEmptyState" style="display: none;">
                    <div class="icon">üìã</div>
                    <p>Belum ada data pekerjaan</p>
                </div>
            </div>

            <div class="card">
                <h4>‚ÑπÔ∏è Cara Hitung Gaji</h4>
                <div style="font-size: 0.85em; color: #666; line-height: 1.8;">
                    <p>üìå <strong>Gaji Pokok</strong> = Pencapaian% √ó <span id="infoGajiPokok">Rp 0</span></p>
                    <p>üìå <strong>Lembur</strong> = Pencapaian% √ó Jam √ó <span id="infoLembur">Rp 0</span></p>
                    <p>üìå <strong>Uang Makan</strong> = Tetap Rp 15.000/hari (jika hadir)</p>
                    <p>üìå <strong>Potongan Telat</strong> = Rp 7.500/30 menit</p>
                    <hr style="margin: 10px 0; border: none; border-top: 1px solid #eee;">
                    <p>‚ö†Ô∏è <strong>Target KPI per hari: Rp 350.000</strong></p>
                    <p>‚úÖ Jika KPI tercapai 100% ‚Üí Gaji & Lembur FULL</p>
                    <p>‚ùå Jika KPI 80% ‚Üí Gaji & Lembur hanya 80%</p>
                </div>
            </div>

            <div class="card">
                <h4>üìã Detail Jam Kerja & Gaji Per Hari</h4>
                <div class="scroll-table-container">
                    <table class="detail-table" id="workHoursTable">
                        <thead>
                            <tr>
                                <th>Tanggal</th>
                                <th>Masuk</th>
                                <th>Pulang</th>
                                <th>Jam Kerja</th>
                                <th>Lembur</th>
                                <th>Gaji</th>
                                <th>Makan</th>
                                <th>U.Lembur</th>
                                <th>Potong</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody id="workHoursBody"></tbody>
                        <tfoot id="workHoursFoot"></tfoot>
                    </table>
                </div>
                <div class="empty-state" id="workHoursEmpty" style="display: none;">
                    <div class="icon">üìã</div>
                    <p>Belum ada data jam kerja</p>
                </div>
            </div>
        </div>

        <!-- Tab: Kinerja -->
        <div class="tab-content" id="tabKinerja">
            <div class="realtime-indicator">
                <div class="realtime-dot"></div>
                <span>Data realtime dari KPI Nala</span>
            </div>

            <div class="gaji-summary-card" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">
                <h3>üéØ Target vs Kinerja Bulan Ini</h3>
                
                <div class="kpi-achievement-banner" style="background: rgba(255,255,255,0.2);">
                    <div style="display: flex; justify-content: space-around; text-align: center;">
                        <div>
                            <div style="font-size: 1.5em; font-weight: bold;" id="kinerjaTarget">Rp 0</div>
                            <div style="font-size: 0.8em; opacity: 0.9;">Target</div>
                        </div>
                        <div style="font-size: 2em; opacity: 0.5;">vs</div>
                        <div>
                            <div style="font-size: 1.5em; font-weight: bold;" id="kinerjaAktual">Rp 0</div>
                            <div style="font-size: 0.8em; opacity: 0.9;">Pencapaian</div>
                        </div>
                    </div>
                </div>

                <div class="kpi-achievement-banner" style="background: rgba(255,255,255,0.2); margin-top: 10px;">
                    <div class="kpi-achievement-header">
                        <span class="kpi-achievement-label">Progress</span>
                        <span class="kpi-achievement-value" id="kinerjaPersentase">0%</span>
                    </div>
                    <div class="kpi-progress-bar">
                        <div class="kpi-progress-fill" id="kinerjaProgressBar" style="width: 0%; background: white;"></div>
                    </div>
                    <div class="kpi-achievement-note" id="kinerjaStatus">üìä Belum ada data</div>
                </div>

                <div class="gaji-grid">
                    <div class="gaji-grid-item">
                        <div class="value" id="statTotalJob">0</div>
                        <div class="label">Total Job</div>
                    </div>
                    <div class="gaji-grid-item">
                        <div class="value" id="statHariKerja">0</div>
                        <div class="label">Hari Kerja</div>
                    </div>
                    <div class="gaji-grid-item">
                        <div class="value" id="statRataRata">Rp 0</div>
                        <div class="label">Rata-rata/Hari</div>
                    </div>
                    <div class="gaji-grid-item">
                        <div class="value" id="statSelisih">Rp 0</div>
                        <div class="label">Selisih Target</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h4>üìÖ Riwayat Pengerjaan</h4>
                <div style="overflow-x: auto;">
                    <table class="trend-table" id="trendTable">
                        <thead>
                            <tr>
                                <th>Tanggal</th>
                                <th>Target</th>
                                <th>Aktual</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="trendTableBody"></tbody>
                    </table>
                </div>
                <div class="empty-state" id="trendEmptyState" style="display: none;">
                    <div class="icon">üìã</div>
                    <p>Belum ada riwayat pengerjaan</p>
                </div>
            </div>
        </div>

        <!-- Tab: AI -->
        <div class="tab-content" id="tabAI">
            <div class="chat-container">
                <div class="chat-messages" id="chatMessages">
                    <div class="chat-message ai">
                        <div class="message-bubble">
                            Halo! üëã Saya asisten AI Nala.

Saya bisa bantu info tentang:
‚Ä¢ Gaji dan cara hitungnya
‚Ä¢ Target KPI
‚Ä¢ Info lembur & telat

Tanya apa saja!
                        </div>
                        <span class="message-time">Just now</span>
                    </div>
                </div>
                
                <div class="chat-input-container">
                    <input type="text" class="chat-input" id="chatInput" placeholder="Ketik pesan..." onkeypress="handleChatKeypress(event)">
                    <button class="send-btn" onclick="sendMessage()">‚û§</button>
                </div>
            </div>
        </div>

        <!-- Bottom Nav -->
        <div class="bottom-nav">
            <button class="nav-item active" onclick="showTab('tabAbsensi', this)">
                <span class="icon">üìç</span>
                <span>Absensi</span>
            </button>
            <button class="nav-item" onclick="showTab('tabGaji', this)">
                <span class="icon">üí∞</span>
                <span>Gaji</span>
            </button>
            <button class="nav-item" onclick="showTab('tabKinerja', this)">
                <span class="icon">üéØ</span>
                <span>Kinerja</span>
            </button>
            <button class="nav-item" onclick="showTab('tabAI', this)">
                <span class="icon">ü§ñ</span>
                <span>AI</span>
            </button>
        </div>
    </div>

    <!-- Loading & Toast -->
    <div class="loading-overlay" id="loadingOverlay"><div class="loading-spinner"></div></div>
    <div class="toast" id="toast"></div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyCx0pG1GxXFbAnt-mCVWAHG6sdaqlPkzfk",
            authDomain: "kpiteknisi.firebaseapp.com",
            projectId: "kpiteknisi",
            storageBucket: "kpiteknisi.appspot.com",
            messagingSenderId: "24578473",
            appId: "1:24578473:web:kpiteknisi"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // ==========================================
        // SALARY CONFIGURATION
        // ==========================================
        const SALARY_CONFIG = {
            workStartTime: '08:30',
            workEndTime: '17:00',
            latePenaltyPer30Min: 7500,
            mealAllowance: 15000,
            targetPerDay: 350000,
            defaultDailySalary: 120000,
            defaultOvertimeRate: 15000,
            specialRates: {
                'fanta': { dailySalary: 150000, overtimeRate: 20000 },
                'hotel': { dailySalary: 100000, overtimeRate: 15000 }
            }
        };

        function getTechnicianSalaryConfig(techName) {
            const nameLower = techName.toLowerCase();
            if (SALARY_CONFIG.specialRates[nameLower]) {
                return {
                    dailySalary: SALARY_CONFIG.specialRates[nameLower].dailySalary,
                    overtimeRate: SALARY_CONFIG.specialRates[nameLower].overtimeRate,
                    mealAllowance: SALARY_CONFIG.mealAllowance
                };
            }
            return {
                dailySalary: SALARY_CONFIG.defaultDailySalary,
                overtimeRate: SALARY_CONFIG.defaultOvertimeRate,
                mealAllowance: SALARY_CONFIG.mealAllowance
            };
        }

        // Global variables
        let currentUser = null;
        let currentLocation = null;
        let todayAttendance = null;
        let validLocations = [];
        let realtimeUnsubscribe = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            updateDateTime();
            setInterval(updateDateTime, 60000);
            await loadTechniciansForLogin();
            await loadValidLocations();

            const savedUser = localStorage.getItem('nalaUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showApp();
            }

            startLocationTracking();
        });

        function updateDateTime() {
            const now = new Date();
            document.getElementById('currentDay').textContent = now.toLocaleDateString('id-ID', { weekday: 'long' });
            document.getElementById('currentDate').textContent = now.toLocaleDateString('id-ID', { 
                day: 'numeric', month: 'long', year: 'numeric' 
            });
        }

        // ==========================================
        // LOGIN
        // ==========================================
        async function loadTechniciansForLogin() {
            try {
                const snapshot = await db.collection('technicians').where('active', '==', true).get();
                const select = document.getElementById('loginName');
                
                snapshot.forEach(doc => {
                    const tech = doc.data();
                    select.innerHTML += `<option value="${doc.id}" data-pin="${tech.pin}">${tech.name}</option>`;
                });
            } catch (error) {
                console.error('Error loading technicians:', error);
            }
        }

        function login() {
            const select = document.getElementById('loginName');
            const pin = document.getElementById('loginPin').value;
            
            if (!select.value) {
                showToast('Pilih nama terlebih dahulu', 'error');
                return;
            }

            const selectedOption = select.options[select.selectedIndex];
            const correctPin = selectedOption.dataset.pin;

            if (pin !== correctPin) {
                showToast('PIN salah!', 'error');
                return;
            }

            currentUser = { id: select.value, name: selectedOption.text };
            localStorage.setItem('nalaUser', JSON.stringify(currentUser));
            showApp();
        }

        function logout() {
            if (realtimeUnsubscribe) {
                realtimeUnsubscribe();
                realtimeUnsubscribe = null;
            }
            localStorage.removeItem('nalaUser');
            currentUser = null;
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('appContainer').classList.remove('active');
        }

        function showApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('appContainer').classList.add('active');
            
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userAvatar').textContent = currentUser.name.charAt(0).toUpperCase();

            const config = getTechnicianSalaryConfig(currentUser.name);
            document.getElementById('infoGajiPokok').textContent = formatRupiah(config.dailySalary);
            document.getElementById('infoLembur').textContent = formatRupiah(config.overtimeRate);

            loadTodayAttendance();
            loadAttendanceHistory();
            loadGajiData();
            loadKinerjaData();
            setupRealtimeListener();
        }

        // ==========================================
        // LOCATION
        // ==========================================
        async function loadValidLocations() {
            try {
                const snapshot = await db.collection('validLocations').get();
                validLocations = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } catch (error) {
                console.error('Error loading locations:', error);
            }
        }

        function startLocationTracking() {
            if (navigator.geolocation) {
                navigator.geolocation.watchPosition(
                    position => {
                        currentLocation = { lat: position.coords.latitude, lng: position.coords.longitude };
                        checkValidLocation();
                    },
                    error => {
                        document.getElementById('locationInfo').textContent = '‚ö†Ô∏è Tidak dapat mengakses lokasi';
                    },
                    { enableHighAccuracy: true }
                );
            }
        }

        function checkValidLocation() {
            if (!currentLocation || validLocations.length === 0) return;

            let nearestLocation = null;
            let minDistance = Infinity;

            validLocations.forEach(loc => {
                const distance = getDistance(currentLocation.lat, currentLocation.lng, loc.lat, loc.lng);
                if (distance < minDistance) {
                    minDistance = distance;
                    nearestLocation = loc;
                }
            });

            const maxDistance = 100;
            if (minDistance <= maxDistance) {
                currentLocation.validLocationId = nearestLocation.id;
                currentLocation.validLocationName = nearestLocation.name;
                document.getElementById('locationInfo').innerHTML = 
                    `‚úÖ <strong>${nearestLocation.name}</strong> (${Math.round(minDistance)}m)`;
            } else {
                currentLocation.validLocationId = null;
                document.getElementById('locationInfo').textContent = `‚ö†Ô∏è Tidak di lokasi valid`;
            }
        }

        function getDistance(lat1, lng1, lat2, lng2) {
            const R = 6371000;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLng/2) * Math.sin(dLng/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        // ==========================================
        // ATTENDANCE
        // ==========================================
        async function loadTodayAttendance() {
            if (!currentUser) return;
            const today = new Date().toISOString().split('T')[0];

            try {
                const snapshot = await db.collection('attendance')
                    .where('technicianId', '==', currentUser.id)
                    .where('date', '==', today)
                    .get();

                if (!snapshot.empty) {
                    todayAttendance = { id: snapshot.docs[0].id, ...snapshot.docs[0].data() };
                    updateAttendanceUI();
                } else {
                    todayAttendance = null;
                    document.getElementById('attendanceIcon').textContent = 'üè†';
                    document.getElementById('attendanceText').textContent = 'Belum Check In';
                    document.getElementById('attendanceTime').textContent = '';
                    document.getElementById('btnCheckIn').disabled = false;
                    document.getElementById('btnCheckOut').disabled = true;
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function updateAttendanceUI() {
            if (!todayAttendance) return;

            if (todayAttendance.checkOut) {
                document.getElementById('attendanceIcon').textContent = '‚úÖ';
                document.getElementById('attendanceText').textContent = 'Sudah Pulang';
                const checkOutTime = new Date(todayAttendance.checkOut.seconds * 1000);
                document.getElementById('attendanceTime').textContent = 
                    `Check Out: ${checkOutTime.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' })}`;
                document.getElementById('btnCheckIn').disabled = true;
                document.getElementById('btnCheckOut').disabled = true;
            } else if (todayAttendance.checkIn) {
                document.getElementById('attendanceIcon').textContent = 'üíº';
                document.getElementById('attendanceText').textContent = 'Sedang Bekerja';
                const checkInTime = new Date(todayAttendance.checkIn.seconds * 1000);
                document.getElementById('attendanceTime').textContent = 
                    `Check In: ${checkInTime.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' })}`;
                document.getElementById('btnCheckIn').disabled = true;
                document.getElementById('btnCheckOut').disabled = false;
            }
        }

        async function checkIn() {
            if (!currentLocation || !currentLocation.validLocationId) {
                showToast('Harus di lokasi valid!', 'error');
                return;
            }

            showLoading(true);

            try {
                const now = new Date();
                const [startHour, startMin] = SALARY_CONFIG.workStartTime.split(':').map(Number);
                const workStartDate = new Date(now);
                workStartDate.setHours(startHour, startMin, 0, 0);
                
                const isLate = now > workStartDate;
                let lateMinutes = isLate ? Math.ceil((now - workStartDate) / (1000 * 60)) : 0;

                const attendanceData = {
                    technicianId: currentUser.id,
                    technicianName: currentUser.name,
                    date: now.toISOString().split('T')[0],
                    checkIn: firebase.firestore.FieldValue.serverTimestamp(),
                    checkInLocation: { lat: currentLocation.lat, lng: currentLocation.lng },
                    checkInLocationName: currentLocation.validLocationName,
                    status: isLate ? 'late' : 'present',
                    lateMinutes: lateMinutes
                };

                const docRef = await db.collection('attendance').add(attendanceData);
                todayAttendance = { id: docRef.id, ...attendanceData, checkIn: { seconds: now.getTime() / 1000 } };
                
                updateAttendanceUI();
                showToast('Check In berhasil!' + (isLate ? ` (Telat ${lateMinutes} mnt)` : ''), isLate ? 'warning' : 'success');
                loadAttendanceHistory();
                loadGajiData();
            } catch (error) {
                showToast('Gagal: ' + error.message, 'error');
            }

            showLoading(false);
        }

        async function checkOut() {
            if (!todayAttendance) {
                showToast('Belum check in!', 'error');
                return;
            }

            if (!currentLocation || !currentLocation.validLocationId) {
                showToast('Harus di lokasi valid!', 'error');
                return;
            }

            showLoading(true);

            try {
                const now = new Date();
                const [endHour, endMin] = SALARY_CONFIG.workEndTime.split(':').map(Number);
                const workEndDate = new Date(now);
                workEndDate.setHours(endHour, endMin, 0, 0);
                
                let overtimeMinutes = now > workEndDate ? Math.floor((now - workEndDate) / (1000 * 60)) : 0;

                await db.collection('attendance').doc(todayAttendance.id).update({
                    checkOut: firebase.firestore.FieldValue.serverTimestamp(),
                    checkOutLocation: { lat: currentLocation.lat, lng: currentLocation.lng },
                    checkOutLocationName: currentLocation.validLocationName,
                    overtimeMinutes: overtimeMinutes
                });

                todayAttendance.checkOut = { seconds: Date.now() / 1000 };
                todayAttendance.overtimeMinutes = overtimeMinutes;
                
                updateAttendanceUI();
                showToast('Check Out berhasil!' + (overtimeMinutes > 0 ? ` (Lembur ${Math.floor(overtimeMinutes/60)}j)` : ''), 'success');
                loadAttendanceHistory();
                loadGajiData();
            } catch (error) {
                showToast('Gagal: ' + error.message, 'error');
            }

            showLoading(false);
        }

        async function loadAttendanceHistory() {
            if (!currentUser) return;

            try {
                const snapshot = await db.collection('attendance')
                    .where('technicianId', '==', currentUser.id)
                    .orderBy('date', 'desc')
                    .limit(10)
                    .get();

                const container = document.getElementById('attendanceHistory');
                
                if (snapshot.empty) {
                    container.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">Belum ada riwayat</p>';
                    return;
                }

                container.innerHTML = snapshot.docs.map(doc => {
                    const att = doc.data();
                    const checkInTime = att.checkIn ? new Date(att.checkIn.seconds * 1000).toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }) : '-';
                    const checkOutTime = att.checkOut ? new Date(att.checkOut.seconds * 1000).toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }) : '-';
                    const dateDisplay = new Date(att.date).toLocaleDateString('id-ID', { weekday: 'short', day: 'numeric', month: 'short' });
                    
                    return `
                        <div class="history-item">
                            <div class="history-date">
                                ${dateDisplay}
                                <span class="history-badge ${att.status === 'late' ? 'late' : 'present'}">${att.status === 'late' ? 'Terlambat' : 'Hadir'}</span>
                            </div>
                            <div class="history-details">
                                <span>üïê In: ${checkInTime}</span>
                                <span>üïê Out: ${checkOutTime}</span>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error:', error);
            }
        }

        // ==========================================
        // GAJI - KPI BASED CALCULATION
        // ==========================================
        async function loadGajiData() {
            if (!currentUser) return;

            const now = new Date();
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            const endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);
            
            const startDate = startOfMonth.toISOString().split('T')[0];
            const endDate = now.toISOString().split('T')[0];

            document.getElementById('gajiPeriod').textContent = 
                `${startOfMonth.toLocaleDateString('id-ID', { day: 'numeric' })} - ${endOfMonth.toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' })}`;

            const config = getTechnicianSalaryConfig(currentUser.name);

            try {
                // Load attendance data
                const attSnapshot = await db.collection('attendance')
                    .where('technicianId', '==', currentUser.id)
                    .where('date', '>=', startDate)
                    .where('date', '<=', endDate)
                    .get();

                // Build attendance map by date
                const attendanceMap = {};
                attSnapshot.forEach(doc => {
                    const att = doc.data();
                    attendanceMap[att.date] = att;
                });

                // Load KPI/jobs data
                const jobsSnapshot = await db.collection('jobs')
                    .where('tanggal', '>=', startDate)
                    .where('tanggal', '<=', endDate)
                    .get();

                // Build KPI map by date
                const kpiMap = {};
                jobsSnapshot.forEach(doc => {
                    const job = doc.data();
                    if (job.teknisi && job.teknisi.toLowerCase().includes(currentUser.name.toLowerCase())) {
                        const techCount = job.teknisi.split(',').length;
                        const income = Math.round((job.pemasukan || 0) / techCount);
                        
                        if (!kpiMap[job.tanggal]) {
                            kpiMap[job.tanggal] = { total: 0, jobs: [] };
                        }
                        kpiMap[job.tanggal].total += income;
                        kpiMap[job.tanggal].jobs.push(job);
                    }
                });

                // Calculate gaji based on KPI achievement
                let gajiData = {
                    workDays: 0,
                    totalLateMinutes: 0,
                    totalOvertimeMinutes: 0,
                    totalSalary: 0,
                    totalMeal: 0,
                    totalOvertime: 0,
                    totalDeduction: 0,
                    totalKpiAchievement: 0,
                    dailyDetails: []
                };

                // Get all unique dates from both attendance and KPI
                const allDates = new Set([...Object.keys(attendanceMap), ...Object.keys(kpiMap)]);

                allDates.forEach(date => {
                    const att = attendanceMap[date];
                    const kpi = kpiMap[date];
                    
                    // Only calculate if has attendance (check-in)
                    if (att && att.checkIn) {
                        gajiData.workDays++;
                        
                        // Calculate KPI achievement for this day
                        const kpiActual = kpi ? kpi.total : 0;
                        const kpiTarget = SALARY_CONFIG.targetPerDay;
                        const kpiPercent = Math.min((kpiActual / kpiTarget) * 100, 100); // Max 100%
                        
                        gajiData.totalKpiAchievement += kpiPercent;

                        // Calculate work hours
                        let checkInTime = null;
                        let checkOutTime = null;
                        let workMinutes = 0;
                        
                        if (att.checkIn && att.checkIn.seconds) {
                            checkInTime = new Date(att.checkIn.seconds * 1000);
                        }
                        if (att.checkOut && att.checkOut.seconds) {
                            checkOutTime = new Date(att.checkOut.seconds * 1000);
                            workMinutes = Math.floor((checkOutTime - checkInTime) / (1000 * 60));
                        }

                        // Gaji Pokok = KPI% √ó Gaji Harian
                        const dailySalary = Math.round((kpiPercent / 100) * config.dailySalary);
                        gajiData.totalSalary += dailySalary;

                        // Uang Makan = Tetap (jika hadir)
                        gajiData.totalMeal += config.mealAllowance;

                        // Lembur = KPI% √ó (Jam √ó Rate)
                        let dailyOvertime = 0;
                        let overtimeMinutes = att.overtimeMinutes || 0;
                        if (overtimeMinutes > 0) {
                            gajiData.totalOvertimeMinutes += overtimeMinutes;
                            const overtimeHours = Math.floor(overtimeMinutes / 60);
                            dailyOvertime = Math.round((kpiPercent / 100) * (overtimeHours * config.overtimeRate));
                            gajiData.totalOvertime += dailyOvertime;
                        }

                        // Potongan telat (tetap, tidak terpengaruh KPI)
                        let dailyDeduction = 0;
                        if (att.lateMinutes && att.lateMinutes > 0) {
                            gajiData.totalLateMinutes += att.lateMinutes;
                            const latePeriods = Math.ceil(att.lateMinutes / 30);
                            dailyDeduction = latePeriods * SALARY_CONFIG.latePenaltyPer30Min;
                            gajiData.totalDeduction += dailyDeduction;
                        }

                        // Store daily detail with work hours info
                        gajiData.dailyDetails.push({
                            date: date,
                            checkInTime: checkInTime,
                            checkOutTime: checkOutTime,
                            workMinutes: workMinutes,
                            overtimeMinutes: overtimeMinutes,
                            lateMinutes: att.lateMinutes || 0,
                            kpiActual: kpiActual,
                            kpiPercent: kpiPercent,
                            salary: dailySalary,
                            overtime: dailyOvertime,
                            meal: config.mealAllowance,
                            deduction: dailyDeduction,
                            total: dailySalary + dailyOvertime + config.mealAllowance - dailyDeduction
                        });
                    }
                });

                // Calculate averages and totals
                const avgKpiPercent = gajiData.workDays > 0 ? Math.round(gajiData.totalKpiAchievement / gajiData.workDays) : 0;
                const totalGaji = gajiData.totalSalary + gajiData.totalMeal + gajiData.totalOvertime - gajiData.totalDeduction;

                // Update UI - Summary
                document.getElementById('gajiTotal').textContent = formatRupiah(totalGaji);
                document.getElementById('avgKpiAchievement').textContent = avgKpiPercent + '%';
                
                const progressBar = document.getElementById('avgKpiProgressBar');
                progressBar.style.width = Math.min(avgKpiPercent, 100) + '%';
                progressBar.className = 'kpi-progress-fill ' + (avgKpiPercent >= 100 ? 'green' : avgKpiPercent >= 80 ? 'yellow' : 'red');

                const kpiNote = document.getElementById('kpiNote');
                if (avgKpiPercent >= 100) {
                    kpiNote.textContent = '‚úÖ KPI Tercapai! Gaji & Lembur FULL';
                } else {
                    kpiNote.textContent = `‚ö†Ô∏è KPI ${avgKpiPercent}% ‚Üí Gaji & Lembur ${avgKpiPercent}%`;
                }

                document.getElementById('gajiHariKerja').textContent = gajiData.workDays;
                document.getElementById('gajiLembur').textContent = Math.floor(gajiData.totalOvertimeMinutes / 60) + ' jam';
                document.getElementById('gajiTelat').textContent = gajiData.totalLateMinutes + ' mnt';
                document.getElementById('gajiPotongan').textContent = formatRupiah(gajiData.totalDeduction);

                // Update UI - Breakdown
                document.getElementById('gajiPokokValue').textContent = formatRupiah(gajiData.totalSalary);
                document.getElementById('gajiPokokDetail').textContent = `${avgKpiPercent}% √ó ${gajiData.workDays} hari √ó ${formatRupiah(config.dailySalary)}`;

                document.getElementById('gajiMakanValue').textContent = formatRupiah(gajiData.totalMeal);
                document.getElementById('gajiMakanDetail').textContent = `${gajiData.workDays} hari √ó Rp 15.000`;

                document.getElementById('gajiLemburValue').textContent = formatRupiah(gajiData.totalOvertime);
                const overtimeHours = Math.floor(gajiData.totalOvertimeMinutes / 60);
                document.getElementById('gajiLemburDetail').textContent = `${avgKpiPercent}% √ó ${overtimeHours} jam √ó ${formatRupiah(config.overtimeRate)}`;

                document.getElementById('gajiPotonganValue').textContent = gajiData.totalDeduction > 0 ? `- ${formatRupiah(gajiData.totalDeduction)}` : '- Rp 0';
                const latePeriods = Math.ceil(gajiData.totalLateMinutes / 30);
                document.getElementById('gajiPotonganDetail').textContent = `${latePeriods} √ó Rp 7.500`;

                document.getElementById('gajiTotalBreakdown').textContent = formatRupiah(totalGaji);

                // Render daily table
                renderGajiDailyTable(gajiData.dailyDetails, config);

                // Calculate and update work hours summary
                const totalWorkMinutes = gajiData.dailyDetails.reduce((sum, d) => sum + (d.workMinutes || 0), 0);
                const totalWorkHours = Math.floor(totalWorkMinutes / 60);
                const totalWorkMins = totalWorkMinutes % 60;
                
                const totalOvertimeHours = Math.floor(gajiData.totalOvertimeMinutes / 60);
                const totalOvertimeMins = gajiData.totalOvertimeMinutes % 60;

                // Update rekap kartu hijau
                document.getElementById('totalJamKerja').textContent = `${totalWorkHours}j ${totalWorkMins}m`;
                document.getElementById('totalJamLembur').textContent = `${totalOvertimeHours}j ${totalOvertimeMins}m`;
                document.getElementById('totalGajiPokok').textContent = formatRupiah(gajiData.totalSalary);
                document.getElementById('totalUangMakan').textContent = formatRupiah(gajiData.totalMeal);
                document.getElementById('totalUangLembur').textContent = formatRupiah(gajiData.totalOvertime);
                document.getElementById('totalPotonganTelat').textContent = formatRupiah(gajiData.totalDeduction);
                document.getElementById('grandTotalSampaiHariIni').textContent = formatRupiah(totalGaji);

                // Render work hours table
                renderWorkHoursTable(gajiData.dailyDetails, config, gajiData);

            } catch (error) {
                console.error('Error loading gaji:', error);
            }
        }

        function renderGajiDailyTable(dailyDetails, config) {
            const tbody = document.getElementById('gajiDailyBody');
            const emptyState = document.getElementById('gajiEmptyState');
            const table = document.getElementById('gajiDailyTable');

            if (dailyDetails.length === 0) {
                table.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            table.style.display = 'table';
            emptyState.style.display = 'none';

            // Sort by date descending
            dailyDetails.sort((a, b) => b.date.localeCompare(a.date));

            tbody.innerHTML = dailyDetails.slice(0, 15).map(day => {
                const dateDisplay = new Date(day.date).toLocaleDateString('id-ID', { 
                    weekday: 'short', day: 'numeric', month: 'short' 
                });
                const isAchieved = day.kpiPercent >= 100;

                return `
                    <tr>
                        <td>${dateDisplay}</td>
                        <td>${formatRupiah(day.kpiActual)}</td>
                        <td>
                            <span class="trend-status ${isAchieved ? 'achieved' : 'below'}">
                                ${Math.round(day.kpiPercent)}%
                            </span>
                        </td>
                        <td class="trend-value ${isAchieved ? 'positive' : 'negative'}">
                            ${formatRupiah(day.total)}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // ==========================================
        // WORK HOURS TABLE RENDERER
        // ==========================================
        function renderWorkHoursTable(dailyDetails, config, gajiData) {
            const tbody = document.getElementById('workHoursBody');
            const tfoot = document.getElementById('workHoursFoot');
            const emptyState = document.getElementById('workHoursEmpty');
            const table = document.getElementById('workHoursTable');

            if (dailyDetails.length === 0) {
                table.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            table.style.display = 'table';
            emptyState.style.display = 'none';

            // Sort by date descending (newest first)
            const sortedDetails = [...dailyDetails].sort((a, b) => b.date.localeCompare(a.date));

            tbody.innerHTML = sortedDetails.map(day => {
                const dateDisplay = new Date(day.date).toLocaleDateString('id-ID', { 
                    weekday: 'short', day: 'numeric', month: 'short' 
                });

                // Format check in/out time
                const checkInStr = day.checkInTime ? 
                    day.checkInTime.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }) : '-';
                const checkOutStr = day.checkOutTime ? 
                    day.checkOutTime.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }) : '-';

                // Format work hours
                const workHours = Math.floor((day.workMinutes || 0) / 60);
                const workMins = (day.workMinutes || 0) % 60;
                const workStr = day.workMinutes > 0 ? `${workHours}j ${workMins}m` : '-';

                // Format overtime
                const otHours = Math.floor((day.overtimeMinutes || 0) / 60);
                const otMins = (day.overtimeMinutes || 0) % 60;
                const otStr = day.overtimeMinutes > 0 ? `${otHours}j ${otMins}m` : '-';
                const hasOvertime = day.overtimeMinutes > 0;

                // Late badge
                const isLate = day.lateMinutes > 0;
                const checkInClass = isLate ? 'late' : 'normal';

                return `
                    <tr>
                        <td class="date-cell">${dateDisplay}</td>
                        <td><span class="time-badge ${checkInClass}">${checkInStr}</span></td>
                        <td>${checkOutStr}</td>
                        <td>${workStr}</td>
                        <td class="${hasOvertime ? 'overtime-highlight' : ''}">${otStr}</td>
                        <td class="money">${formatRupiahShort(day.salary)}</td>
                        <td class="money">${formatRupiahShort(day.meal)}</td>
                        <td class="money">${day.overtime > 0 ? formatRupiahShort(day.overtime) : '-'}</td>
                        <td style="color: #c62828;">${day.deduction > 0 ? '-' + formatRupiahShort(day.deduction) : '-'}</td>
                        <td class="money" style="font-weight: bold; background: #e8f5e9;">${formatRupiahShort(day.total)}</td>
                    </tr>
                `;
            }).join('');

            // Calculate totals for footer
            const totalWorkMinutes = dailyDetails.reduce((sum, d) => sum + (d.workMinutes || 0), 0);
            const totalWorkHours = Math.floor(totalWorkMinutes / 60);
            const totalWorkMins = totalWorkMinutes % 60;

            const totalOtMinutes = dailyDetails.reduce((sum, d) => sum + (d.overtimeMinutes || 0), 0);
            const totalOtHours = Math.floor(totalOtMinutes / 60);
            const totalOtMins = totalOtMinutes % 60;

            const totalGajiPokok = dailyDetails.reduce((sum, d) => sum + (d.salary || 0), 0);
            const totalMakan = dailyDetails.reduce((sum, d) => sum + (d.meal || 0), 0);
            const totalUangLembur = dailyDetails.reduce((sum, d) => sum + (d.overtime || 0), 0);
            const totalPotongan = dailyDetails.reduce((sum, d) => sum + (d.deduction || 0), 0);
            const totalGajiHarian = dailyDetails.reduce((sum, d) => sum + (d.total || 0), 0);

            tfoot.innerHTML = `
                <tr>
                    <td colspan="3" style="text-align: right;">TOTAL:</td>
                    <td>${totalWorkHours}j ${totalWorkMins}m</td>
                    <td>${totalOtHours}j ${totalOtMins}m</td>
                    <td>${formatRupiahShort(totalGajiPokok)}</td>
                    <td>${formatRupiahShort(totalMakan)}</td>
                    <td>${formatRupiahShort(totalUangLembur)}</td>
                    <td>${totalPotongan > 0 ? '-' + formatRupiahShort(totalPotongan) : '-'}</td>
                    <td style="font-size: 1.1em;">${formatRupiahShort(totalGajiHarian)}</td>
                </tr>
            `;
        }

        // Format rupiah singkat (untuk tabel)
        function formatRupiahShort(num) {
            if (!num || num === 0) return 'Rp 0';
            if (num >= 1000000) {
                return 'Rp ' + (num / 1000000).toFixed(1) + 'jt';
            } else if (num >= 1000) {
                return 'Rp ' + Math.round(num / 1000) + 'rb';
            }
            return 'Rp ' + num.toLocaleString('id-ID');
        }

        // ==========================================
        // KINERJA (KPI Summary)
        // ==========================================
        async function loadKinerjaData() {
            if (!currentUser) return;

            const now = new Date();
            const startDate = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
            const endDate = now.toISOString().split('T')[0];

            try {
                const jobsSnapshot = await db.collection('jobs')
                    .where('tanggal', '>=', startDate)
                    .where('tanggal', '<=', endDate)
                    .get();

                const myJobs = [];
                const dailyData = {};

                jobsSnapshot.forEach(doc => {
                    const job = doc.data();
                    if (job.teknisi && job.teknisi.toLowerCase().includes(currentUser.name.toLowerCase())) {
                        const techCount = job.teknisi.split(',').length;
                        const income = Math.round((job.pemasukan || 0) / techCount);
                        
                        myJobs.push({ id: doc.id, ...job, myIncome: income });

                        if (!dailyData[job.tanggal]) {
                            dailyData[job.tanggal] = { jobs: [], total: 0 };
                        }
                        dailyData[job.tanggal].jobs.push(job);
                        dailyData[job.tanggal].total += income;
                    }
                });

                const totalJobs = myJobs.length;
                const totalIncome = myJobs.reduce((sum, job) => sum + job.myIncome, 0);
                const workDays = Object.keys(dailyData).length;
                
                const target = workDays * SALARY_CONFIG.targetPerDay;
                const achievement = target > 0 ? Math.round((totalIncome / target) * 100) : 0;
                const avgPerDay = workDays > 0 ? Math.round(totalIncome / workDays) : 0;
                const selisih = totalIncome - target;

                // Update UI
                document.getElementById('kinerjaTarget').textContent = formatRupiah(target);
                document.getElementById('kinerjaAktual').textContent = formatRupiah(totalIncome);
                document.getElementById('kinerjaPersentase').textContent = achievement + '%';
                document.getElementById('kinerjaProgressBar').style.width = Math.min(achievement, 100) + '%';

                const statusEl = document.getElementById('kinerjaStatus');
                if (achievement >= 100) {
                    statusEl.textContent = '‚úÖ TARGET TERCAPAI! Gaji FULL';
                } else if (achievement >= 80) {
                    statusEl.textContent = `‚ö†Ô∏è Hampir! Kurang ${formatRupiah(Math.abs(selisih))}`;
                } else {
                    statusEl.textContent = `‚ùå Kurang ${formatRupiah(Math.abs(selisih))} untuk target`;
                }

                document.getElementById('statTotalJob').textContent = totalJobs;
                document.getElementById('statHariKerja').textContent = workDays;
                document.getElementById('statRataRata').textContent = formatRupiah(avgPerDay);
                document.getElementById('statSelisih').textContent = (selisih >= 0 ? '+' : '') + formatRupiah(selisih);

                renderTrendTable(dailyData);

            } catch (error) {
                console.error('Error:', error);
            }
        }

        function renderTrendTable(dailyData) {
            const tbody = document.getElementById('trendTableBody');
            const emptyState = document.getElementById('trendEmptyState');
            const table = document.getElementById('trendTable');

            const dates = Object.keys(dailyData).sort((a, b) => b.localeCompare(a));

            if (dates.length === 0) {
                table.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            table.style.display = 'table';
            emptyState.style.display = 'none';

            tbody.innerHTML = dates.slice(0, 10).map(date => {
                const data = dailyData[date];
                const target = SALARY_CONFIG.targetPerDay;
                const actual = data.total;
                const isAchieved = actual >= target;
                const diff = actual - target;

                const dateDisplay = new Date(date).toLocaleDateString('id-ID', { 
                    weekday: 'short', day: 'numeric', month: 'short' 
                });

                return `
                    <tr>
                        <td>${dateDisplay}</td>
                        <td>${formatRupiah(target)}</td>
                        <td class="trend-value ${isAchieved ? 'positive' : 'negative'}">${formatRupiah(actual)}</td>
                        <td>
                            <span class="trend-status ${isAchieved ? 'achieved' : 'below'}">
                                ${isAchieved ? '‚úÖ' : '‚ùå'} ${diff >= 0 ? '+' : ''}${formatRupiah(diff)}
                            </span>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Realtime listener
        function setupRealtimeListener() {
            if (!currentUser) return;

            const now = new Date();
            const startDate = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];

            realtimeUnsubscribe = db.collection('jobs')
                .where('tanggal', '>=', startDate)
                .onSnapshot(() => {
                    console.log('üìä Data updated');
                    loadGajiData();
                    loadKinerjaData();
                });
        }

        // ==========================================
        // AI CHAT
        // ==========================================
        function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message) return;

            addChatMessage(message, 'user');
            input.value = '';
            showTypingIndicator();

            setTimeout(() => {
                hideTypingIndicator();
                addChatMessage(getLocalResponse(message), 'ai');
            }, 800);
        }

        function addChatMessage(text, type) {
            const container = document.getElementById('chatMessages');
            const now = new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
            
            container.innerHTML += `
                <div class="chat-message ${type}">
                    <div class="message-bubble">${text}</div>
                    <span class="message-time">${now}</span>
                </div>
            `;
            container.scrollTop = container.scrollHeight;
        }

        function showTypingIndicator() {
            const container = document.getElementById('chatMessages');
            container.innerHTML += `
                <div class="chat-message ai" id="typingIndicator">
                    <div class="message-bubble"><div class="typing-indicator"><span></span><span></span><span></span></div></div>
                </div>
            `;
            container.scrollTop = container.scrollHeight;
        }

        function hideTypingIndicator() {
            const el = document.getElementById('typingIndicator');
            if (el) el.remove();
        }

        function getLocalResponse(message) {
            const lowerMsg = message.toLowerCase();
            const config = getTechnicianSalaryConfig(currentUser.name);
            
            if (lowerMsg.includes('gaji') || lowerMsg.includes('hitung')) {
                return `üí∞ Cara Hitung Gaji ${currentUser.name}:

üìå Gaji Pokok = KPI% √ó ${formatRupiah(config.dailySalary)}
üìå Lembur = KPI% √ó Jam √ó ${formatRupiah(config.overtimeRate)}
üìå Uang Makan = Rp 15.000 (tetap)
üìå Potongan Telat = Rp 7.500/30 menit

Target KPI: Rp 350.000/hari

‚úÖ KPI 100% ‚Üí Gaji FULL
‚ùå KPI 80% ‚Üí Gaji hanya 80%`;
            }
            
            if (lowerMsg.includes('target') || lowerMsg.includes('kpi')) {
                return `üéØ Target KPI:

Per Hari: Rp 350.000
Per Bulan: Rp 350.000 √ó Hari Kerja

Jika tidak tercapai:
‚Üí Gaji & Lembur dipotong sesuai %

Contoh: KPI 80%
‚Üí Gaji = 80% √ó ${formatRupiah(config.dailySalary)} = ${formatRupiah(config.dailySalary * 0.8)}`;
            }
            
            if (lowerMsg.includes('lembur')) {
                return `‚è∞ Info Lembur:

Jam pulang normal: 17:00
Rate: ${formatRupiah(config.overtimeRate)}/jam

‚ö†Ô∏è Lembur juga berdasarkan KPI!

Contoh: Lembur 2 jam, KPI 80%
‚Üí 80% √ó 2 √ó ${formatRupiah(config.overtimeRate)} = ${formatRupiah(config.overtimeRate * 2 * 0.8)}`;
            }

            if (lowerMsg.includes('telat') || lowerMsg.includes('terlambat')) {
                return `‚ö†Ô∏è Potongan Terlambat:

Jam masuk: 08:30
Denda: Rp 7.500 per 30 menit

Contoh:
‚Ä¢ Telat 15 mnt = Rp 7.500
‚Ä¢ Telat 45 mnt = Rp 15.000

‚ùó Potongan telat TETAP (tidak terpengaruh KPI)`;
            }
            
            if (lowerMsg.includes('halo') || lowerMsg.includes('hai')) {
                return `üëã Halo ${currentUser.name}!

Tanya saya tentang:
‚Ä¢ "cara hitung gaji"
‚Ä¢ "target kpi"
‚Ä¢ "info lembur"
‚Ä¢ "denda telat"`;
            }
            
            return `ü§î Tanya:
‚Ä¢ "cara hitung gaji"
‚Ä¢ "target kpi"
‚Ä¢ "info lembur"
‚Ä¢ "denda telat"`;
        }

        function handleChatKeypress(e) { if (e.key === 'Enter') sendMessage(); }

        // ==========================================
        // UTILITIES
        // ==========================================
        function showTab(tabId, btn) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
            
            document.getElementById(tabId).classList.add('active');
            btn.classList.add('active');

            if (tabId === 'tabGaji') loadGajiData();
            else if (tabId === 'tabKinerja') loadKinerjaData();
        }

        function showLoading(show) {
            document.getElementById('loadingOverlay').classList.toggle('active', show);
        }

        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast show ' + type;
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        function formatRupiah(num) {
            return 'Rp ' + (num || 0).toLocaleString('id-ID');
        }

        // Global functions
        window.login = login;
        window.logout = logout;
        window.showTab = showTab;
        window.checkIn = checkIn;
        window.checkOut = checkOut;
        window.sendMessage = sendMessage;
        window.handleChatKeypress = handleChatKeypress;

        // ==========================================
        // DEBUG & SAMPLE DATA FUNCTIONS
        // ==========================================
        async function debugCheckData() {
            if (!currentUser) {
                alert('Login dulu!');
                return;
            }

            const output = document.getElementById('debugOutput');
            output.style.display = 'block';
            output.innerHTML = 'üîÑ Loading...\n';

            const now = new Date();
            const startDate = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
            const endDate = now.toISOString().split('T')[0];

            try {
                // Check attendance
                const attSnapshot = await db.collection('attendance')
                    .where('technicianId', '==', currentUser.id)
                    .where('date', '>=', startDate)
                    .where('date', '<=', endDate)
                    .get();

                output.innerHTML += `\nüë§ User: ${currentUser.name} (ID: ${currentUser.id})\n`;
                output.innerHTML += `üìÖ Periode: ${startDate} s/d ${endDate}\n`;
                output.innerHTML += `\nüìã ATTENDANCE DATA:\n`;
                output.innerHTML += `   Found: ${attSnapshot.size} records\n`;
                
                attSnapshot.forEach(doc => {
                    const d = doc.data();
                    output.innerHTML += `   - ${d.date}: CheckIn=${d.checkIn ? '‚úÖ' : '‚ùå'}, CheckOut=${d.checkOut ? '‚úÖ' : '‚ùå'}, Late=${d.lateMinutes || 0}m, OT=${d.overtimeMinutes || 0}m\n`;
                });

                // Check jobs
                const jobsSnapshot = await db.collection('jobs')
                    .where('tanggal', '>=', startDate)
                    .where('tanggal', '<=', endDate)
                    .get();

                output.innerHTML += `\nüíº JOBS DATA:\n`;
                output.innerHTML += `   Total jobs this month: ${jobsSnapshot.size}\n`;
                
                let myJobs = 0;
                jobsSnapshot.forEach(doc => {
                    const j = doc.data();
                    const isMyJob = j.teknisi && j.teknisi.toLowerCase().includes(currentUser.name.toLowerCase());
                    if (isMyJob) {
                        myJobs++;
                        output.innerHTML += `   - ${j.tanggal}: ${j.teknisi} | Rp ${(j.pemasukan || 0).toLocaleString()}\n`;
                    }
                });
                output.innerHTML += `   Jobs for ${currentUser.name}: ${myJobs}\n`;

                output.innerHTML += `\n‚úÖ Debug selesai!`;

            } catch (error) {
                output.innerHTML += `\n‚ùå ERROR: ${error.message}`;
            }
        }

        async function generateSampleData() {
            if (!currentUser) {
                alert('Login dulu!');
                return;
            }

            if (!confirm(`Generate sample data untuk ${currentUser.name}?\n\nIni akan membuat:\n- 5 hari attendance\n- 5 jobs dengan KPI berbeda`)) {
                return;
            }

            showLoading(true);
            const output = document.getElementById('debugOutput');
            output.style.display = 'block';
            output.innerHTML = 'üîÑ Generating sample data...\n';

            try {
                const now = new Date();
                const batch = db.batch();

                // Generate 5 days of sample data
                for (let i = 1; i <= 5; i++) {
                    const date = new Date(now.getFullYear(), now.getMonth(), i);
                    const dateStr = date.toISOString().split('T')[0];

                    // Random check in time (08:15 - 08:45)
                    const checkInHour = 8;
                    const checkInMin = 15 + Math.floor(Math.random() * 30);
                    const checkInDate = new Date(date);
                    checkInDate.setHours(checkInHour, checkInMin, 0, 0);

                    // Random check out time (17:00 - 19:00)
                    const checkOutHour = 17 + Math.floor(Math.random() * 2);
                    const checkOutMin = Math.floor(Math.random() * 60);
                    const checkOutDate = new Date(date);
                    checkOutDate.setHours(checkOutHour, checkOutMin, 0, 0);

                    // Calculate late minutes (if after 08:30)
                    const lateMinutes = checkInMin > 30 ? checkInMin - 30 : 0;

                    // Calculate overtime (if after 17:00)
                    const overtimeMinutes = checkOutHour > 17 ? ((checkOutHour - 17) * 60 + checkOutMin) : (checkOutHour === 17 ? checkOutMin : 0);

                    // Create attendance doc
                    const attRef = db.collection('attendance').doc(`sample_${currentUser.id}_${dateStr}`);
                    batch.set(attRef, {
                        technicianId: currentUser.id,
                        technicianName: currentUser.name,
                        date: dateStr,
                        checkIn: firebase.firestore.Timestamp.fromDate(checkInDate),
                        checkOut: firebase.firestore.Timestamp.fromDate(checkOutDate),
                        checkInLocation: { lat: -5.135399, lng: 119.423790 },
                        checkOutLocation: { lat: -5.135399, lng: 119.423790 },
                        checkInLocationName: 'Kantor Nala',
                        checkOutLocationName: 'Kantor Nala',
                        status: lateMinutes > 0 ? 'late' : 'present',
                        lateMinutes: lateMinutes,
                        overtimeMinutes: overtimeMinutes,
                        isSampleData: true
                    });

                    // Create job with random KPI (250k - 450k)
                    const kpiAmount = 250000 + Math.floor(Math.random() * 200000);
                    const jobRef = db.collection('jobs').doc(`sample_job_${currentUser.id}_${dateStr}`);
                    batch.set(jobRef, {
                        tanggal: dateStr,
                        teknisi: currentUser.name,
                        pelanggan: `Customer Sample ${i}`,
                        alamat: 'Makassar',
                        jenisPekerjaan: 'Service AC',
                        pemasukan: kpiAmount,
                        isSampleData: true
                    });

                    output.innerHTML += `‚úÖ Created: ${dateStr} | In: ${checkInHour}:${checkInMin.toString().padStart(2,'0')} | Out: ${checkOutHour}:${checkOutMin.toString().padStart(2,'0')} | KPI: Rp ${kpiAmount.toLocaleString()}\n`;
                }

                await batch.commit();
                output.innerHTML += `\nüéâ Sample data created! Refreshing...\n`;

                // Refresh data
                setTimeout(() => {
                    loadGajiData();
                    loadKinerjaData();
                    loadAttendanceHistory();
                    showToast('Sample data berhasil dibuat!', 'success');
                }, 1000);

            } catch (error) {
                output.innerHTML += `\n‚ùå ERROR: ${error.message}`;
                showToast('Gagal: ' + error.message, 'error');
            }

            showLoading(false);
        }

        async function clearSampleData() {
            if (!currentUser) {
                alert('Login dulu!');
                return;
            }

            if (!confirm(`Hapus semua sample data untuk ${currentUser.name}?`)) {
                return;
            }

            showLoading(true);
            const output = document.getElementById('debugOutput');
            output.style.display = 'block';
            output.innerHTML = 'üîÑ Deleting sample data...\n';

            try {
                // Delete sample attendance
                const attSnapshot = await db.collection('attendance')
                    .where('technicianId', '==', currentUser.id)
                    .where('isSampleData', '==', true)
                    .get();

                const batch1 = db.batch();
                attSnapshot.forEach(doc => {
                    batch1.delete(doc.ref);
                    output.innerHTML += `üóëÔ∏è Deleted attendance: ${doc.id}\n`;
                });
                await batch1.commit();

                // Delete sample jobs
                const jobsSnapshot = await db.collection('jobs')
                    .where('teknisi', '==', currentUser.name)
                    .where('isSampleData', '==', true)
                    .get();

                const batch2 = db.batch();
                jobsSnapshot.forEach(doc => {
                    batch2.delete(doc.ref);
                    output.innerHTML += `üóëÔ∏è Deleted job: ${doc.id}\n`;
                });
                await batch2.commit();

                output.innerHTML += `\nüéâ Sample data deleted! Refreshing...\n`;

                // Refresh data
                setTimeout(() => {
                    loadGajiData();
                    loadKinerjaData();
                    loadAttendanceHistory();
                    showToast('Sample data berhasil dihapus!', 'success');
                }, 1000);

            } catch (error) {
                output.innerHTML += `\n‚ùå ERROR: ${error.message}`;
                showToast('Gagal: ' + error.message, 'error');
            }

            showLoading(false);
        }

        window.debugCheckData = debugCheckData;
        window.generateSampleData = generateSampleData;
        window.clearSampleData = clearSampleData;
    </script>
</body>
</html>

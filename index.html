<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1e3c72">
    <title>Nala Teknisi App</title>
    <link rel="manifest" href="manifest.json">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #f0f2f5;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Login Screen */
        .login-screen {
            min-height: 100vh;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .login-screen.hidden {
            display: none;
        }

        .login-logo {
            font-size: 4em;
            margin-bottom: 20px;
        }

        .login-title {
            color: white;
            font-size: 1.8em;
            margin-bottom: 10px;
        }

        .login-subtitle {
            color: rgba(255,255,255,0.8);
            margin-bottom: 40px;
        }

        .login-form {
            background: white;
            padding: 30px;
            border-radius: 20px;
            width: 100%;
            max-width: 350px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .pin-input {
            letter-spacing: 15px;
            text-align: center;
            font-size: 1.5em;
            font-weight: bold;
        }

        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:active {
            transform: scale(0.98);
        }

        /* Main App */
        .app-container {
            display: none;
            min-height: 100vh;
            padding-bottom: 80px;
        }

        .app-container.active {
            display: block;
        }

        /* Header */
        .app-header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 20px;
            padding-top: 40px;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2em;
        }

        .user-name {
            font-size: 1.1em;
            font-weight: 600;
        }

        .user-role {
            font-size: 0.85em;
            opacity: 0.8;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 10px 15px;
            border-radius: 10px;
            font-size: 0.9em;
            cursor: pointer;
        }

        .date-display {
            text-align: center;
            padding: 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
        }

        .date-display .day {
            font-size: 1.5em;
            font-weight: bold;
        }

        .date-display .full-date {
            font-size: 0.9em;
            opacity: 0.9;
        }

        /* Tab Content */
        .tab-content {
            display: none;
            padding: 20px;
        }

        .tab-content.active {
            display: block;
        }

        /* Attendance Styles */
        .attendance-card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .attendance-status {
            text-align: center;
            margin-bottom: 25px;
        }

        .status-icon {
            font-size: 3em;
            margin-bottom: 10px;
        }

        .status-text {
            font-size: 1.2em;
            font-weight: 600;
            color: #333;
        }

        .status-time {
            color: #666;
            margin-top: 5px;
        }

        .attendance-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .attendance-btn {
            padding: 20px;
            border: none;
            border-radius: 15px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }

        .attendance-btn .icon {
            font-size: 1.5em;
        }

        .attendance-btn.check-in {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }

        .attendance-btn.check-out {
            background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
            color: white;
        }

        .attendance-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .location-info {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            text-align: center;
            font-size: 0.9em;
            color: #666;
        }

        .history-item {
            background: white;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .history-date {
            font-weight: 600;
            color: #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .history-badge {
            font-size: 0.75em;
            padding: 4px 10px;
            border-radius: 20px;
            font-weight: 500;
        }

        .history-badge.present {
            background: #d4edda;
            color: #155724;
        }

        .history-badge.late {
            background: #fff3cd;
            color: #856404;
        }

        .history-details {
            display: flex;
            gap: 20px;
            margin-top: 8px;
            font-size: 0.9em;
            color: #666;
        }

        /* KPI Styles */
        .kpi-summary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .kpi-summary h3 {
            margin-bottom: 20px;
            font-size: 1.1em;
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .kpi-item {
            text-align: center;
            padding: 15px;
            background: rgba(255,255,255,0.15);
            border-radius: 12px;
        }

        .kpi-item .value {
            font-size: 1.5em;
            font-weight: bold;
        }

        .kpi-item .label {
            font-size: 0.85em;
            opacity: 0.9;
            margin-top: 5px;
        }

        .kpi-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .kpi-card h4 {
            margin-bottom: 15px;
            color: #333;
        }

        .progress-bar {
            height: 10px;
            background: #e9ecef;
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            border-radius: 5px;
            transition: width 0.5s ease;
        }

        .progress-fill.green {
            background: linear-gradient(90deg, #11998e, #38ef7d);
        }

        .progress-fill.blue {
            background: linear-gradient(90deg, #667eea, #764ba2);
        }

        /* ==========================================
           EARNINGS DASHBOARD STYLES (NEW!)
           ========================================== */
        .earnings-card {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(17, 153, 142, 0.3);
        }

        .earnings-card h3 {
            margin-bottom: 5px;
            font-size: 1.1em;
            opacity: 0.9;
        }

        .earnings-total {
            font-size: 2.2em;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .earnings-date {
            font-size: 0.9em;
            opacity: 0.85;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .earnings-breakdown {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .earnings-breakdown h4 {
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .earnings-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .earnings-row:last-child {
            border-bottom: none;
        }

        .earnings-row.total {
            border-top: 2px solid #e0e0e0;
            margin-top: 10px;
            padding-top: 15px;
            font-weight: bold;
        }

        .earnings-label {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #555;
        }

        .earnings-label .icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1em;
        }

        .earnings-label .icon.salary {
            background: #e3f2fd;
        }

        .earnings-label .icon.meal {
            background: #fff3e0;
        }

        .earnings-label .icon.overtime {
            background: #e8f5e9;
        }

        .earnings-label .icon.deduction {
            background: #ffebee;
        }

        .earnings-label .icon.kpi {
            background: #f3e5f5;
        }

        .earnings-value {
            font-weight: 600;
            color: #333;
        }

        .earnings-value.positive {
            color: #2e7d32;
        }

        .earnings-value.negative {
            color: #c62828;
        }

        .earnings-value.total {
            font-size: 1.2em;
            color: #1e3c72;
        }

        .earnings-detail {
            font-size: 0.8em;
            color: #999;
            margin-top: 2px;
        }

        .realtime-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85em;
            color: #666;
            margin-bottom: 15px;
        }

        .realtime-dot {
            width: 8px;
            height: 8px;
            background: #4caf50;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .work-time-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .work-time-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .work-time-item {
            text-align: center;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .work-time-item .value {
            font-size: 1.1em;
            font-weight: bold;
            color: #333;
        }

        .work-time-item .label {
            font-size: 0.75em;
            color: #666;
            margin-top: 4px;
        }

        .work-time-item.late .value {
            color: #f57c00;
        }

        .work-time-item.overtime .value {
            color: #2e7d32;
        }

        /* AI Chat Styles */
        .chat-container {
            background: white;
            border-radius: 20px;
            height: calc(100vh - 280px);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .chat-message {
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
        }

        .chat-message.user {
            align-items: flex-end;
        }

        .chat-message.ai {
            align-items: flex-start;
        }

        .message-bubble {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 18px;
            font-size: 0.95em;
            line-height: 1.4;
            white-space: pre-wrap;
        }

        .chat-message.user .message-bubble {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-bottom-right-radius: 5px;
        }

        .chat-message.ai .message-bubble {
            background: #f0f2f5;
            color: #333;
            border-bottom-left-radius: 5px;
        }

        .message-time {
            font-size: 0.75em;
            color: #999;
            margin-top: 5px;
        }

        .chat-input-container {
            display: flex;
            padding: 15px;
            border-top: 1px solid #eee;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 12px 18px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 1em;
            outline: none;
        }

        .chat-input:focus {
            border-color: #667eea;
        }

        .send-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-size: 1.2em;
            cursor: pointer;
        }

        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 10px;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            background: #999;
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 100% { opacity: 0.3; transform: translateY(0); }
            50% { opacity: 1; transform: translateY(-4px); }
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            box-shadow: 0 -2px 15px rgba(0,0,0,0.1);
            z-index: 100;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px 16px;
            border: none;
            background: none;
            color: #999;
            font-size: 0.75em;
            cursor: pointer;
            transition: all 0.3s;
        }

        .nav-item .icon {
            font-size: 1.5em;
        }

        .nav-item.active {
            color: #667eea;
        }

        /* Loading */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .loading-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #333;
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 0.9em;
            opacity: 0;
            transition: all 0.3s;
            z-index: 1001;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .toast.success { background: #4caf50; }
        .toast.error { background: #f44336; }
        .toast.warning { background: #ff9800; }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
        <div class="login-logo">üîß</div>
        <h1 class="login-title">Nala Teknisi</h1>
        <p class="login-subtitle">Aplikasi Absensi & KPI</p>

        <div class="login-form">
            <div class="form-group">
                <label>Pilih Nama</label>
                <select class="form-input" id="loginName">
                    <option value="">-- Pilih Nama --</option>
                </select>
            </div>
            <div class="form-group">
                <label>PIN (4 digit)</label>
                <input type="password" class="form-input pin-input" id="loginPin" maxlength="4" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            </div>
            <button class="btn btn-primary" onclick="login()">üîì Masuk</button>
        </div>
    </div>

    <!-- Main App -->
    <div class="app-container" id="appContainer">
        <div class="app-header">
            <div class="header-top">
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">A</div>
                    <div>
                        <div class="user-name" id="userName">Teknisi</div>
                        <div class="user-role">Teknisi AC</div>
                    </div>
                </div>
                <button class="logout-btn" onclick="logout()">Keluar</button>
            </div>
            <div class="date-display">
                <div class="day" id="currentDay">Senin</div>
                <div class="full-date" id="currentDate">1 Januari 2026</div>
            </div>
        </div>

        <!-- Tab: Absensi -->
        <div class="tab-content active" id="tabAbsensi">
            <div class="attendance-card">
                <div class="attendance-status">
                    <div class="status-icon" id="attendanceIcon">üè†</div>
                    <div class="status-text" id="attendanceText">Belum Check In</div>
                    <div class="status-time" id="attendanceTime"></div>
                </div>
                
                <div class="attendance-buttons">
                    <button class="attendance-btn check-in" id="btnCheckIn" onclick="checkIn()">
                        <span class="icon">üìç</span>
                        <span>Check In</span>
                    </button>
                    <button class="attendance-btn check-out" id="btnCheckOut" onclick="checkOut()" disabled>
                        <span class="icon">üèÅ</span>
                        <span>Check Out</span>
                    </button>
                </div>

                <div class="location-info" id="locationInfo">
                    üìç Mengambil lokasi...
                </div>
            </div>

            <h3 style="margin-bottom: 15px; color: #333;">üìã Riwayat Absensi</h3>
            <div id="attendanceHistory">
                <!-- Populated by JS -->
            </div>
        </div>

        <!-- Tab: Pendapatan (NEW!) -->
        <div class="tab-content" id="tabEarnings">
            <div class="realtime-indicator">
                <div class="realtime-dot"></div>
                <span>Data realtime dari KPI Nala</span>
            </div>

            <div class="earnings-card">
                <h3>üí∞ Total Pendapatan Hari Ini</h3>
                <div class="earnings-total" id="earningsTotalToday">Rp 0</div>
                <div class="earnings-date">
                    <span>üìÖ</span>
                    <span id="earningsDate">Senin, 1 Januari 2026</span>
                </div>
            </div>

            <div class="work-time-card">
                <h4 style="color: #333; margin-bottom: 5px;">‚è∞ Jam Kerja Hari Ini</h4>
                <div class="work-time-grid">
                    <div class="work-time-item">
                        <div class="value" id="workCheckIn">--:--</div>
                        <div class="label">Check In</div>
                    </div>
                    <div class="work-time-item">
                        <div class="value" id="workCheckOut">--:--</div>
                        <div class="label">Check Out</div>
                    </div>
                    <div class="work-time-item">
                        <div class="value" id="workDuration">0 jam</div>
                        <div class="label">Total Jam</div>
                    </div>
                </div>
                <div class="work-time-grid" style="margin-top: 10px;">
                    <div class="work-time-item late">
                        <div class="value" id="lateMinutes">0 mnt</div>
                        <div class="label">Terlambat</div>
                    </div>
                    <div class="work-time-item overtime">
                        <div class="value" id="overtimeHours">0 jam</div>
                        <div class="label">Lembur</div>
                    </div>
                    <div class="work-time-item">
                        <div class="value" id="todayJobs">0</div>
                        <div class="label">Pekerjaan</div>
                    </div>
                </div>
            </div>

            <div class="earnings-breakdown">
                <h4>üìä Rincian Pendapatan</h4>
                
                <div class="earnings-row">
                    <div class="earnings-label">
                        <div class="icon salary">üíº</div>
                        <div>
                            <div>Gaji Pokok Harian</div>
                            <div class="earnings-detail" id="salaryDetail">Sesuai absensi</div>
                        </div>
                    </div>
                    <div class="earnings-value positive" id="earningsSalary">Rp 0</div>
                </div>

                <div class="earnings-row">
                    <div class="earnings-label">
                        <div class="icon meal">üçΩÔ∏è</div>
                        <div>
                            <div>Uang Makan</div>
                            <div class="earnings-detail">Per hari hadir</div>
                        </div>
                    </div>
                    <div class="earnings-value positive" id="earningsMeal">Rp 0</div>
                </div>

                <div class="earnings-row">
                    <div class="earnings-label">
                        <div class="icon overtime">‚è∞</div>
                        <div>
                            <div>Uang Lembur</div>
                            <div class="earnings-detail" id="overtimeDetail">Setelah jam 17:00</div>
                        </div>
                    </div>
                    <div class="earnings-value positive" id="earningsOvertime">Rp 0</div>
                </div>

                <div class="earnings-row">
                    <div class="earnings-label">
                        <div class="icon kpi">üìà</div>
                        <div>
                            <div>Pendapatan KPI</div>
                            <div class="earnings-detail" id="kpiDetail">Dari pekerjaan hari ini</div>
                        </div>
                    </div>
                    <div class="earnings-value positive" id="earningsKPI">Rp 0</div>
                </div>

                <div class="earnings-row">
                    <div class="earnings-label">
                        <div class="icon deduction">‚ö†Ô∏è</div>
                        <div>
                            <div>Potongan Terlambat</div>
                            <div class="earnings-detail" id="lateDetail">Rp 7.500/30 menit</div>
                        </div>
                    </div>
                    <div class="earnings-value negative" id="earningsDeduction">- Rp 0</div>
                </div>

                <div class="earnings-row total">
                    <div class="earnings-label">
                        <strong>TOTAL HARI INI</strong>
                    </div>
                    <div class="earnings-value total" id="earningsTotalBreakdown">Rp 0</div>
                </div>
            </div>

            <div class="earnings-breakdown">
                <h4>üìÖ Ringkasan Bulan Ini</h4>
                <div class="earnings-row">
                    <div class="earnings-label">Total Hari Kerja</div>
                    <div class="earnings-value" id="monthWorkDays">0 hari</div>
                </div>
                <div class="earnings-row">
                    <div class="earnings-label">Total Gaji Pokok</div>
                    <div class="earnings-value positive" id="monthSalary">Rp 0</div>
                </div>
                <div class="earnings-row">
                    <div class="earnings-label">Total Uang Makan</div>
                    <div class="earnings-value positive" id="monthMeal">Rp 0</div>
                </div>
                <div class="earnings-row">
                    <div class="earnings-label">Total Lembur</div>
                    <div class="earnings-value positive" id="monthOvertime">Rp 0</div>
                </div>
                <div class="earnings-row">
                    <div class="earnings-label">Total Pendapatan KPI</div>
                    <div class="earnings-value positive" id="monthKPI">Rp 0</div>
                </div>
                <div class="earnings-row">
                    <div class="earnings-label">Total Potongan</div>
                    <div class="earnings-value negative" id="monthDeduction">- Rp 0</div>
                </div>
                <div class="earnings-row total">
                    <div class="earnings-label"><strong>TOTAL BULAN INI</strong></div>
                    <div class="earnings-value total" id="monthTotal">Rp 0</div>
                </div>
            </div>
        </div>

        <!-- Tab: KPI -->
        <div class="tab-content" id="tabKPI">
            <div class="kpi-summary">
                <h3>üìä Ringkasan Bulan Ini</h3>
                <div class="kpi-grid">
                    <div class="kpi-item">
                        <div class="value" id="kpiTotalJobs">0</div>
                        <div class="label">Total Job</div>
                    </div>
                    <div class="kpi-item">
                        <div class="value" id="kpiTotalIncome">Rp 0</div>
                        <div class="label">Pendapatan</div>
                    </div>
                    <div class="kpi-item">
                        <div class="value" id="kpiWorkDays">0</div>
                        <div class="label">Hari Kerja</div>
                    </div>
                    <div class="kpi-item">
                        <div class="value" id="kpiAchievement">0%</div>
                        <div class="label">Pencapaian</div>
                    </div>
                </div>
            </div>

            <div class="kpi-card">
                <h4>üéØ Target vs Realisasi</h4>
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <span>Pencapaian Target</span>
                    <span id="kpiProgressText">0%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill green" id="kpiProgressBar" style="width: 0%"></div>
                </div>
                <div style="display: flex; justify-content: space-between; font-size: 0.85em; color: #666;">
                    <span>Target: <span id="kpiTargetValue">Rp 0</span></span>
                    <span>Tercapai: <span id="kpiReachedValue">Rp 0</span></span>
                </div>
            </div>

            <div class="kpi-card">
                <h4>üìÖ Kehadiran Bulan Ini</h4>
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <span>Tingkat Kehadiran</span>
                    <span id="attendanceProgressText">0%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill blue" id="attendanceProgressBar" style="width: 0%"></div>
                </div>
                <div style="display: flex; justify-content: space-between; font-size: 0.85em; color: #666;">
                    <span>Hadir: <span id="attendanceDays">0</span> hari</span>
                    <span>Target: <span id="attendanceTarget">0</span> hari</span>
                </div>
            </div>

            <h3 style="margin: 20px 0 15px; color: #333;">üìã Detail Pekerjaan Bulan Ini</h3>
            <div id="kpiJobList">
                <!-- Populated by JS -->
            </div>
        </div>

        <!-- Tab: AI Assistant -->
        <div class="tab-content" id="tabAI">
            <div class="chat-container">
                <div class="chat-messages" id="chatMessages">
                    <div class="chat-message ai">
                        <div class="message-bubble">
                            Halo! üëã Saya asisten AI Nala. Saya bisa membantu Anda dengan:
                            <br><br>
                            ‚Ä¢ Informasi tentang pekerjaan AC<br>
                            ‚Ä¢ Tips perawatan AC<br>
                            ‚Ä¢ Troubleshooting masalah AC<br>
                            ‚Ä¢ Pertanyaan tentang KPI Anda<br>
                            <br>
                            Silakan tanya apa saja!
                        </div>
                        <span class="message-time">Just now</span>
                    </div>
                </div>
                
                <div class="chat-input-container">
                    <input type="text" class="chat-input" id="chatInput" placeholder="Ketik pesan..." onkeypress="handleChatKeypress(event)">
                    <button class="send-btn" onclick="sendMessage()">‚û§</button>
                </div>
            </div>
        </div>

        <!-- Bottom Navigation (Updated with 4 tabs) -->
        <div class="bottom-nav">
            <button class="nav-item active" onclick="showTab('tabAbsensi', this)">
                <span class="icon">üìç</span>
                <span>Absensi</span>
            </button>
            <button class="nav-item" onclick="showTab('tabEarnings', this)">
                <span class="icon">üí∞</span>
                <span>Pendapatan</span>
            </button>
            <button class="nav-item" onclick="showTab('tabKPI', this)">
                <span class="icon">üìä</span>
                <span>KPI</span>
            </button>
            <button class="nav-item" onclick="showTab('tabAI', this)">
                <span class="icon">ü§ñ</span>
                <span>AI</span>
            </button>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCx0pG1GxXFbAnt-mCVWAHG6sdaqlPkzfk",
            authDomain: "kpiteknisi.firebaseapp.com",
            projectId: "kpiteknisi",
            storageBucket: "kpiteknisi.appspot.com",
            messagingSenderId: "24578473",
            appId: "1:24578473:web:kpiteknisi"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // ==========================================
        // SALARY CONFIGURATION (NEW!)
        // ==========================================
        const SALARY_CONFIG = {
            workStartTime: '08:30',
            workEndTime: '17:00',
            latePenaltyPer30Min: 7500,
            mealAllowance: 15000,
            defaultDailySalary: 120000,
            defaultOvertimeRate: 15000,
            // Special rates per technician
            specialRates: {
                'fanta': { dailySalary: 150000, overtimeRate: 20000 },
                'hotel': { dailySalary: 100000, overtimeRate: 15000 }
            }
        };

        // Get salary config for specific technician
        function getTechnicianSalaryConfig(techName) {
            const nameLower = techName.toLowerCase();
            if (SALARY_CONFIG.specialRates[nameLower]) {
                return {
                    dailySalary: SALARY_CONFIG.specialRates[nameLower].dailySalary,
                    overtimeRate: SALARY_CONFIG.specialRates[nameLower].overtimeRate,
                    mealAllowance: SALARY_CONFIG.mealAllowance
                };
            }
            return {
                dailySalary: SALARY_CONFIG.defaultDailySalary,
                overtimeRate: SALARY_CONFIG.defaultOvertimeRate,
                mealAllowance: SALARY_CONFIG.mealAllowance
            };
        }

        // Current user
        let currentUser = null;
        let currentLocation = null;
        let todayAttendance = null;
        let validLocations = [];
        let earningsUnsubscribe = null; // For realtime listener

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            updateDateTime();
            setInterval(updateDateTime, 60000);

            // Load technicians for login
            await loadTechniciansForLogin();
            
            // Load valid locations
            await loadValidLocations();

            // Check saved session
            const savedUser = localStorage.getItem('nalaUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showApp();
            }

            // Start GPS tracking
            startLocationTracking();
        });

        function updateDateTime() {
            const now = new Date();
            document.getElementById('currentDay').textContent = now.toLocaleDateString('id-ID', { weekday: 'long' });
            document.getElementById('currentDate').textContent = now.toLocaleDateString('id-ID', { 
                day: 'numeric', 
                month: 'long', 
                year: 'numeric' 
            });
        }

        // ==========================================
        // LOGIN
        // ==========================================

        async function loadTechniciansForLogin() {
            try {
                const snapshot = await db.collection('technicians').where('active', '==', true).get();
                const select = document.getElementById('loginName');
                
                snapshot.forEach(doc => {
                    const tech = doc.data();
                    select.innerHTML += `<option value="${doc.id}" data-pin="${tech.pin}">${tech.name}</option>`;
                });
            } catch (error) {
                console.error('Error loading technicians:', error);
            }
        }

        function login() {
            const select = document.getElementById('loginName');
            const pin = document.getElementById('loginPin').value;
            
            if (!select.value) {
                showToast('Pilih nama terlebih dahulu', 'error');
                return;
            }

            const selectedOption = select.options[select.selectedIndex];
            const correctPin = selectedOption.dataset.pin;

            if (pin !== correctPin) {
                showToast('PIN salah!', 'error');
                return;
            }

            currentUser = {
                id: select.value,
                name: selectedOption.text
            };

            localStorage.setItem('nalaUser', JSON.stringify(currentUser));
            showApp();
        }

        function logout() {
            // Unsubscribe from realtime listener
            if (earningsUnsubscribe) {
                earningsUnsubscribe();
                earningsUnsubscribe = null;
            }
            
            localStorage.removeItem('nalaUser');
            currentUser = null;
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('appContainer').classList.remove('active');
        }

        function showApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('appContainer').classList.add('active');
            
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userAvatar').textContent = currentUser.name.charAt(0).toUpperCase();

            loadTodayAttendance();
            loadAttendanceHistory();
            loadKPIData();
            loadEarningsData(); // Load earnings data
            setupRealtimeEarnings(); // Setup realtime listener
        }

        // ==========================================
        // LOCATION
        // ==========================================

        async function loadValidLocations() {
            try {
                const snapshot = await db.collection('validLocations').get();
                validLocations = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } catch (error) {
                console.error('Error loading locations:', error);
            }
        }

        function startLocationTracking() {
            if (navigator.geolocation) {
                navigator.geolocation.watchPosition(
                    position => {
                        currentLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        checkValidLocation();
                    },
                    error => {
                        document.getElementById('locationInfo').textContent = '‚ö†Ô∏è Tidak dapat mengakses lokasi';
                    },
                    { enableHighAccuracy: true }
                );
            }
        }

        function checkValidLocation() {
            if (!currentLocation || validLocations.length === 0) return;

            let nearestLocation = null;
            let minDistance = Infinity;

            validLocations.forEach(loc => {
                const distance = getDistance(
                    currentLocation.lat, currentLocation.lng,
                    loc.lat, loc.lng
                );
                if (distance < minDistance) {
                    minDistance = distance;
                    nearestLocation = loc;
                }
            });

            const maxDistance = 100; // 100 meters
            if (minDistance <= maxDistance) {
                currentLocation.validLocationId = nearestLocation.id;
                currentLocation.validLocationName = nearestLocation.name;
                document.getElementById('locationInfo').innerHTML = 
                    `‚úÖ <strong>${nearestLocation.name}</strong> (${Math.round(minDistance)}m)`;
            } else {
                currentLocation.validLocationId = null;
                document.getElementById('locationInfo').textContent = 
                    `‚ö†Ô∏è Anda tidak di lokasi yang valid (${nearestLocation ? nearestLocation.name + ': ' + Math.round(minDistance) + 'm' : 'tidak ada lokasi'})`;
            }
        }

        function getDistance(lat1, lng1, lat2, lng2) {
            const R = 6371000;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLng/2) * Math.sin(dLng/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        // ==========================================
        // ATTENDANCE
        // ==========================================

        async function loadTodayAttendance() {
            if (!currentUser) return;

            const today = new Date().toISOString().split('T')[0];

            try {
                const snapshot = await db.collection('attendance')
                    .where('technicianId', '==', currentUser.id)
                    .where('date', '==', today)
                    .get();

                if (!snapshot.empty) {
                    todayAttendance = { id: snapshot.docs[0].id, ...snapshot.docs[0].data() };
                    updateAttendanceUI();
                } else {
                    todayAttendance = null;
                    document.getElementById('attendanceIcon').textContent = 'üè†';
                    document.getElementById('attendanceText').textContent = 'Belum Check In';
                    document.getElementById('attendanceTime').textContent = '';
                    document.getElementById('btnCheckIn').disabled = false;
                    document.getElementById('btnCheckOut').disabled = true;
                }
            } catch (error) {
                console.error('Error loading today attendance:', error);
            }
        }

        function updateAttendanceUI() {
            if (!todayAttendance) return;

            if (todayAttendance.checkOut) {
                document.getElementById('attendanceIcon').textContent = '‚úÖ';
                document.getElementById('attendanceText').textContent = 'Sudah Pulang';
                const checkOutTime = new Date(todayAttendance.checkOut.seconds * 1000);
                document.getElementById('attendanceTime').textContent = 
                    `Check Out: ${checkOutTime.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' })}`;
                document.getElementById('btnCheckIn').disabled = true;
                document.getElementById('btnCheckOut').disabled = true;
            } else if (todayAttendance.checkIn) {
                document.getElementById('attendanceIcon').textContent = 'üíº';
                document.getElementById('attendanceText').textContent = 'Sedang Bekerja';
                const checkInTime = new Date(todayAttendance.checkIn.seconds * 1000);
                document.getElementById('attendanceTime').textContent = 
                    `Check In: ${checkInTime.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' })}`;
                document.getElementById('btnCheckIn').disabled = true;
                document.getElementById('btnCheckOut').disabled = false;
            }
        }

        async function checkIn() {
            if (!currentLocation || !currentLocation.validLocationId) {
                showToast('Anda harus berada di lokasi yang valid untuk absen!', 'error');
                return;
            }

            showLoading(true);

            try {
                const now = new Date();
                const [startHour, startMin] = SALARY_CONFIG.workStartTime.split(':').map(Number);
                const workStartDate = new Date(now);
                workStartDate.setHours(startHour, startMin, 0, 0);
                
                const isLate = now > workStartDate;
                let lateMinutes = 0;
                if (isLate) {
                    lateMinutes = Math.ceil((now - workStartDate) / (1000 * 60));
                }

                const attendanceData = {
                    technicianId: currentUser.id,
                    technicianName: currentUser.name,
                    date: now.toISOString().split('T')[0],
                    checkIn: firebase.firestore.FieldValue.serverTimestamp(),
                    checkInLocation: {
                        lat: currentLocation.lat,
                        lng: currentLocation.lng
                    },
                    checkInLocationName: currentLocation.validLocationName,
                    status: isLate ? 'late' : 'present',
                    lateMinutes: lateMinutes
                };

                const docRef = await db.collection('attendance').add(attendanceData);
                todayAttendance = { id: docRef.id, ...attendanceData, checkIn: { seconds: now.getTime() / 1000 } };
                
                updateAttendanceUI();
                showToast('Check In berhasil! ' + (isLate ? `(Terlambat ${lateMinutes} menit)` : ''), isLate ? 'warning' : 'success');
                loadAttendanceHistory();
                loadEarningsData(); // Refresh earnings
            } catch (error) {
                console.error('Check in error:', error);
                showToast('Gagal check in: ' + error.message, 'error');
            }

            showLoading(false);
        }

        async function checkOut() {
            if (!todayAttendance) {
                showToast('Anda belum check in!', 'error');
                return;
            }

            if (!currentLocation || !currentLocation.validLocationId) {
                showToast('Anda harus berada di lokasi yang valid untuk absen!', 'error');
                return;
            }

            showLoading(true);

            try {
                const now = new Date();
                const [endHour, endMin] = SALARY_CONFIG.workEndTime.split(':').map(Number);
                const workEndDate = new Date(now);
                workEndDate.setHours(endHour, endMin, 0, 0);
                
                let overtimeMinutes = 0;
                if (now > workEndDate) {
                    overtimeMinutes = Math.floor((now - workEndDate) / (1000 * 60));
                }

                await db.collection('attendance').doc(todayAttendance.id).update({
                    checkOut: firebase.firestore.FieldValue.serverTimestamp(),
                    checkOutLocation: {
                        lat: currentLocation.lat,
                        lng: currentLocation.lng
                    },
                    checkOutLocationName: currentLocation.validLocationName,
                    overtimeMinutes: overtimeMinutes
                });

                todayAttendance.checkOut = { seconds: Date.now() / 1000 };
                todayAttendance.overtimeMinutes = overtimeMinutes;
                
                updateAttendanceUI();
                showToast('Check Out berhasil!' + (overtimeMinutes > 0 ? ` (Lembur ${Math.floor(overtimeMinutes/60)} jam ${overtimeMinutes%60} menit)` : ''), 'success');
                loadAttendanceHistory();
                loadEarningsData(); // Refresh earnings
            } catch (error) {
                console.error('Check out error:', error);
                showToast('Gagal check out: ' + error.message, 'error');
            }

            showLoading(false);
        }

        async function loadAttendanceHistory() {
            if (!currentUser) return;

            try {
                const snapshot = await db.collection('attendance')
                    .where('technicianId', '==', currentUser.id)
                    .orderBy('date', 'desc')
                    .limit(10)
                    .get();

                const historyContainer = document.getElementById('attendanceHistory');
                
                if (snapshot.empty) {
                    historyContainer.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">Belum ada riwayat absensi</p>';
                    return;
                }

                historyContainer.innerHTML = snapshot.docs.map(doc => {
                    const att = doc.data();
                    const checkInTime = att.checkIn ? new Date(att.checkIn.seconds * 1000).toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }) : '-';
                    const checkOutTime = att.checkOut ? new Date(att.checkOut.seconds * 1000).toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }) : '-';
                    const dateDisplay = new Date(att.date).toLocaleDateString('id-ID', { weekday: 'short', day: 'numeric', month: 'short' });
                    
                    const statusClass = att.status === 'late' ? 'late' : 'present';
                    const statusText = att.status === 'late' ? 'Terlambat' : 'Hadir';

                    return `
                        <div class="history-item">
                            <div class="history-date">
                                ${dateDisplay}
                                <span class="history-badge ${statusClass}">${statusText}</span>
                            </div>
                            <div class="history-details">
                                <span>üïê In: ${checkInTime}</span>
                                <span>üïê Out: ${checkOutTime}</span>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading history:', error);
            }
        }

        // ==========================================
        // EARNINGS CALCULATION (NEW!)
        // ==========================================

        async function loadEarningsData() {
            if (!currentUser) return;

            const now = new Date();
            const today = now.toISOString().split('T')[0];
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];

            // Update date display
            document.getElementById('earningsDate').textContent = now.toLocaleDateString('id-ID', { 
                weekday: 'long', 
                day: 'numeric', 
                month: 'long', 
                year: 'numeric' 
            });

            const config = getTechnicianSalaryConfig(currentUser.name);

            try {
                // Load today's attendance
                const todayAttSnapshot = await db.collection('attendance')
                    .where('technicianId', '==', currentUser.id)
                    .where('date', '==', today)
                    .get();

                let todayEarnings = {
                    salary: 0,
                    meal: 0,
                    overtime: 0,
                    kpiIncome: 0,
                    deduction: 0,
                    checkIn: null,
                    checkOut: null,
                    lateMinutes: 0,
                    overtimeMinutes: 0
                };

                if (!todayAttSnapshot.empty) {
                    const att = todayAttSnapshot.docs[0].data();
                    
                    // Basic salary and meal if checked in
                    if (att.checkIn) {
                        todayEarnings.salary = config.dailySalary;
                        todayEarnings.meal = config.mealAllowance;
                        todayEarnings.checkIn = new Date(att.checkIn.seconds * 1000);
                    }

                    if (att.checkOut) {
                        todayEarnings.checkOut = new Date(att.checkOut.seconds * 1000);
                    }

                    // Late penalty
                    if (att.lateMinutes && att.lateMinutes > 0) {
                        todayEarnings.lateMinutes = att.lateMinutes;
                        const latePeriods = Math.ceil(att.lateMinutes / 30);
                        todayEarnings.deduction = latePeriods * SALARY_CONFIG.latePenaltyPer30Min;
                    }

                    // Overtime
                    if (att.overtimeMinutes && att.overtimeMinutes > 0) {
                        todayEarnings.overtimeMinutes = att.overtimeMinutes;
                        const overtimeHours = Math.floor(att.overtimeMinutes / 60);
                        todayEarnings.overtime = overtimeHours * config.overtimeRate;
                    }
                }

                // Load today's KPI income
                const jobsSnapshot = await db.collection('jobs')
                    .where('tanggal', '==', today)
                    .get();

                jobsSnapshot.forEach(doc => {
                    const job = doc.data();
                    if (job.teknisi && job.teknisi.toLowerCase().includes(currentUser.name.toLowerCase())) {
                        const techCount = job.teknisi.split(',').length;
                        todayEarnings.kpiIncome += Math.round((job.pemasukan || 0) / techCount);
                    }
                });

                // Calculate total
                const todayTotal = todayEarnings.salary + todayEarnings.meal + todayEarnings.overtime + todayEarnings.kpiIncome - todayEarnings.deduction;

                // Update Today UI
                updateTodayEarningsUI(todayEarnings, todayTotal, config);

                // Load monthly data
                await loadMonthlyEarnings(startOfMonth, today, config);

            } catch (error) {
                console.error('Error loading earnings:', error);
            }
        }

        function updateTodayEarningsUI(earnings, total, config) {
            // Total card
            document.getElementById('earningsTotalToday').textContent = formatRupiah(total);
            document.getElementById('earningsTotalBreakdown').textContent = formatRupiah(total);

            // Work time
            document.getElementById('workCheckIn').textContent = earnings.checkIn ? 
                earnings.checkIn.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }) : '--:--';
            document.getElementById('workCheckOut').textContent = earnings.checkOut ? 
                earnings.checkOut.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }) : '--:--';

            // Duration
            if (earnings.checkIn && earnings.checkOut) {
                const duration = (earnings.checkOut - earnings.checkIn) / (1000 * 60 * 60);
                document.getElementById('workDuration').textContent = duration.toFixed(1) + ' jam';
            } else if (earnings.checkIn) {
                const duration = (new Date() - earnings.checkIn) / (1000 * 60 * 60);
                document.getElementById('workDuration').textContent = duration.toFixed(1) + ' jam';
            } else {
                document.getElementById('workDuration').textContent = '0 jam';
            }

            // Late
            document.getElementById('lateMinutes').textContent = earnings.lateMinutes > 0 ? 
                earnings.lateMinutes + ' mnt' : '0 mnt';

            // Overtime
            const overtimeHours = Math.floor(earnings.overtimeMinutes / 60);
            const overtimeMins = earnings.overtimeMinutes % 60;
            document.getElementById('overtimeHours').textContent = earnings.overtimeMinutes > 0 ? 
                `${overtimeHours}j ${overtimeMins}m` : '0 jam';

            // Jobs count - will be updated from KPI
            document.getElementById('todayJobs').textContent = earnings.kpiIncome > 0 ? '‚úì' : '0';

            // Breakdown
            document.getElementById('earningsSalary').textContent = formatRupiah(earnings.salary);
            document.getElementById('salaryDetail').textContent = earnings.salary > 0 ? 
                `${formatRupiah(config.dailySalary)}/hari` : 'Belum check in';

            document.getElementById('earningsMeal').textContent = formatRupiah(earnings.meal);
            document.getElementById('earningsOvertime').textContent = formatRupiah(earnings.overtime);
            document.getElementById('overtimeDetail').textContent = earnings.overtimeMinutes > 0 ? 
                `${overtimeHours} jam √ó ${formatRupiah(config.overtimeRate)}` : 'Tidak ada lembur';

            document.getElementById('earningsKPI').textContent = formatRupiah(earnings.kpiIncome);
            document.getElementById('kpiDetail').textContent = earnings.kpiIncome > 0 ? 
                'Dari pekerjaan hari ini' : 'Belum ada pekerjaan';

            document.getElementById('earningsDeduction').textContent = earnings.deduction > 0 ? 
                `- ${formatRupiah(earnings.deduction)}` : '- Rp 0';
            document.getElementById('lateDetail').textContent = earnings.lateMinutes > 0 ? 
                `${Math.ceil(earnings.lateMinutes/30)} √ó Rp 7.500` : 'Tidak terlambat';
        }

        async function loadMonthlyEarnings(startDate, endDate, config) {
            try {
                // Load all attendance for this month
                const attSnapshot = await db.collection('attendance')
                    .where('technicianId', '==', currentUser.id)
                    .where('date', '>=', startDate)
                    .where('date', '<=', endDate)
                    .get();

                let monthlyData = {
                    workDays: attSnapshot.size,
                    salary: 0,
                    meal: 0,
                    overtime: 0,
                    deduction: 0
                };

                attSnapshot.forEach(doc => {
                    const att = doc.data();
                    
                    if (att.checkIn) {
                        monthlyData.salary += config.dailySalary;
                        monthlyData.meal += config.mealAllowance;
                    }

                    if (att.lateMinutes && att.lateMinutes > 0) {
                        const latePeriods = Math.ceil(att.lateMinutes / 30);
                        monthlyData.deduction += latePeriods * SALARY_CONFIG.latePenaltyPer30Min;
                    }

                    if (att.overtimeMinutes && att.overtimeMinutes > 0) {
                        const overtimeHours = Math.floor(att.overtimeMinutes / 60);
                        monthlyData.overtime += overtimeHours * config.overtimeRate;
                    }
                });

                // Load KPI income for month
                const jobsSnapshot = await db.collection('jobs')
                    .where('tanggal', '>=', startDate)
                    .where('tanggal', '<=', endDate)
                    .get();

                let monthlyKPI = 0;
                jobsSnapshot.forEach(doc => {
                    const job = doc.data();
                    if (job.teknisi && job.teknisi.toLowerCase().includes(currentUser.name.toLowerCase())) {
                        const techCount = job.teknisi.split(',').length;
                        monthlyKPI += Math.round((job.pemasukan || 0) / techCount);
                    }
                });

                const monthlyTotal = monthlyData.salary + monthlyData.meal + monthlyData.overtime + monthlyKPI - monthlyData.deduction;

                // Update Monthly UI
                document.getElementById('monthWorkDays').textContent = monthlyData.workDays + ' hari';
                document.getElementById('monthSalary').textContent = formatRupiah(monthlyData.salary);
                document.getElementById('monthMeal').textContent = formatRupiah(monthlyData.meal);
                document.getElementById('monthOvertime').textContent = formatRupiah(monthlyData.overtime);
                document.getElementById('monthKPI').textContent = formatRupiah(monthlyKPI);
                document.getElementById('monthDeduction').textContent = monthlyData.deduction > 0 ? 
                    `- ${formatRupiah(monthlyData.deduction)}` : '- Rp 0';
                document.getElementById('monthTotal').textContent = formatRupiah(monthlyTotal);

            } catch (error) {
                console.error('Error loading monthly earnings:', error);
            }
        }

        // Setup realtime listener for earnings
        function setupRealtimeEarnings() {
            if (!currentUser) return;

            const today = new Date().toISOString().split('T')[0];

            // Listen to jobs collection for realtime updates
            earningsUnsubscribe = db.collection('jobs')
                .where('tanggal', '==', today)
                .onSnapshot(snapshot => {
                    console.log('üìä KPI data updated - refreshing earnings...');
                    loadEarningsData();
                }, error => {
                    console.error('Realtime listener error:', error);
                });
        }

        // ==========================================
        // KPI
        // ==========================================

        async function loadKPIData() {
            if (!currentUser) return;

            const now = new Date();
            const startDate = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
            const endDate = now.toISOString().split('T')[0];

            try {
                // Load jobs from KPI database
                const jobsSnapshot = await db.collection('jobs')
                    .where('tanggal', '>=', startDate)
                    .where('tanggal', '<=', endDate)
                    .get();

                const myJobs = [];
                jobsSnapshot.forEach(doc => {
                    const job = doc.data();
                    if (job.teknisi && job.teknisi.toLowerCase().includes(currentUser.name.toLowerCase())) {
                        myJobs.push({ id: doc.id, ...job });
                    }
                });

                // Calculate KPI
                const totalJobs = myJobs.length;
                const totalIncome = myJobs.reduce((sum, job) => {
                    const techCount = job.teknisi.split(',').length;
                    return sum + Math.round((job.pemasukan || 0) / techCount);
                }, 0);

                // Count unique work days
                const workDays = new Set(myJobs.map(j => j.tanggal)).size;

                // Calculate target (350rb per day)
                const targetPerDay = 350000;
                const target = workDays * targetPerDay;
                const achievement = target > 0 ? Math.round((totalIncome / target) * 100) : 0;

                // Update UI
                document.getElementById('kpiTotalJobs').textContent = totalJobs;
                document.getElementById('kpiTotalIncome').textContent = formatRupiah(totalIncome);
                document.getElementById('kpiWorkDays').textContent = workDays;
                document.getElementById('kpiAchievement').textContent = achievement + '%';

                document.getElementById('kpiProgressText').textContent = achievement + '%';
                document.getElementById('kpiProgressBar').style.width = Math.min(achievement, 100) + '%';
                document.getElementById('kpiTargetValue').textContent = formatRupiah(target);
                document.getElementById('kpiReachedValue').textContent = formatRupiah(totalIncome);

                // Load attendance for this month
                const attendanceSnapshot = await db.collection('attendance')
                    .where('technicianId', '==', currentUser.id)
                    .where('date', '>=', startDate)
                    .where('date', '<=', endDate)
                    .get();

                const attendanceDays = attendanceSnapshot.size;
                const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
                const attendancePercent = Math.round((attendanceDays / daysInMonth) * 100);

                document.getElementById('attendanceProgressText').textContent = attendancePercent + '%';
                document.getElementById('attendanceProgressBar').style.width = attendancePercent + '%';
                document.getElementById('attendanceDays').textContent = attendanceDays;
                document.getElementById('attendanceTarget').textContent = daysInMonth;

                // Render job list
                renderKPIJobList(myJobs);

            } catch (error) {
                console.error('Error loading KPI:', error);
            }
        }

        function renderKPIJobList(jobs) {
            const container = document.getElementById('kpiJobList');
            
            if (jobs.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">Belum ada pekerjaan bulan ini</p>';
                return;
            }

            // Group by date
            const grouped = {};
            jobs.forEach(job => {
                if (!grouped[job.tanggal]) grouped[job.tanggal] = [];
                grouped[job.tanggal].push(job);
            });

            container.innerHTML = Object.entries(grouped)
                .sort((a, b) => b[0].localeCompare(a[0]))
                .slice(0, 5)
                .map(([date, dayJobs]) => {
                    const dateDisplay = new Date(date).toLocaleDateString('id-ID', { weekday: 'short', day: 'numeric', month: 'short' });
                    const dayTotal = dayJobs.reduce((sum, j) => sum + Math.round((j.pemasukan || 0) / j.teknisi.split(',').length), 0);

                    return `
                        <div class="kpi-card">
                            <h4>üìÖ ${dateDisplay} - ${formatRupiah(dayTotal)}</h4>
                            ${dayJobs.map(job => `
                                <div style="padding: 8px 0; border-bottom: 1px solid #eee;">
                                    <div style="font-weight: 600;">${job.jasa}</div>
                                    <div style="font-size: 0.85em; color: #666;">
                                        üìç ${job.customer} ‚Ä¢ üí∞ ${formatRupiah(Math.round((job.pemasukan || 0) / job.teknisi.split(',').length))}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }).join('');
        }

        function formatRupiah(num) {
            return 'Rp ' + (num || 0).toLocaleString('id-ID');
        }

        // ==========================================
        // AI CHAT (Simplified local responses)
        // ==========================================

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;

            addChatMessage(message, 'user');
            input.value = '';

            showTypingIndicator();

            setTimeout(() => {
                hideTypingIndicator();
                const response = getLocalResponse(message);
                addChatMessage(response, 'ai');
            }, 1000);
        }

        function addChatMessage(text, type) {
            const container = document.getElementById('chatMessages');
            const now = new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
            
            container.innerHTML += `
                <div class="chat-message ${type}">
                    <div class="message-bubble">${text}</div>
                    <span class="message-time">${now}</span>
                </div>
            `;
            
            container.scrollTop = container.scrollHeight;
        }

        function showTypingIndicator() {
            const container = document.getElementById('chatMessages');
            container.innerHTML += `
                <div class="chat-message ai" id="typingIndicator">
                    <div class="message-bubble">
                        <div class="typing-indicator">
                            <span></span><span></span><span></span>
                        </div>
                    </div>
                </div>
            `;
            container.scrollTop = container.scrollHeight;
        }

        function hideTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            if (indicator) indicator.remove();
        }

        function getLocalResponse(message) {
            const lowerMsg = message.toLowerCase();
            
            if (lowerMsg.includes('gaji') || lowerMsg.includes('pendapatan') || lowerMsg.includes('salary')) {
                const config = getTechnicianSalaryConfig(currentUser.name);
                return `üí∞ Info Gaji ${currentUser.name}:\n\n‚Ä¢ Gaji Pokok: ${formatRupiah(config.dailySalary)}/hari\n‚Ä¢ Uang Makan: ${formatRupiah(config.mealAllowance)}/hari\n‚Ä¢ Lembur: ${formatRupiah(config.overtimeRate)}/jam\n‚Ä¢ Denda Terlambat: Rp 7.500/30 menit\n\nLihat detail lengkap di tab Pendapatan! üìä`;
            }
            
            if (lowerMsg.includes('lembur') || lowerMsg.includes('overtime')) {
                return '‚è∞ Info Lembur:\n\nLembur dihitung jika checkout setelah jam 17:00.\n\nRumus: Jam lembur √ó tarif lembur per jam\n\nContoh: Checkout jam 19:00 = 2 jam lembur';
            }

            if (lowerMsg.includes('terlambat') || lowerMsg.includes('telat') || lowerMsg.includes('denda')) {
                return '‚ö†Ô∏è Info Keterlambatan:\n\nJam masuk: 08:30\nDenda: Rp 7.500 per 30 menit\n\nContoh:\n‚Ä¢ Telat 15 menit = Rp 7.500\n‚Ä¢ Telat 45 menit = Rp 15.000\n‚Ä¢ Telat 1 jam = Rp 15.000';
            }
            
            if (lowerMsg.includes('halo') || lowerMsg.includes('hai') || lowerMsg.includes('hi')) {
                return `üëã Halo ${currentUser.name}!\n\nSaya bisa membantu info tentang:\n‚Ä¢ Gaji dan pendapatan\n‚Ä¢ Lembur\n‚Ä¢ Keterlambatan\n‚Ä¢ Tips service AC\n\nTanya apa saja!`;
            }
            
            return 'ü§î Maaf, saya belum mengerti pertanyaan itu.\n\nCoba tanya tentang:\n‚Ä¢ "berapa gaji saya?"\n‚Ä¢ "info lembur"\n‚Ä¢ "denda terlambat"';
        }

        function handleChatKeypress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // ==========================================
        // UTILITIES
        // ==========================================

        function showTab(tabId, btn) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
            
            document.getElementById(tabId).classList.add('active');
            btn.classList.add('active');

            if (tabId === 'tabKPI') {
                loadKPIData();
            } else if (tabId === 'tabEarnings') {
                loadEarningsData();
            }
        }

        function showLoading(show) {
            document.getElementById('loadingOverlay').classList.toggle('active', show);
        }

        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast show ' + type;
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Make functions global
        window.login = login;
        window.logout = logout;
        window.showTab = showTab;
        window.checkIn = checkIn;
        window.checkOut = checkOut;
        window.sendMessage = sendMessage;
        window.handleChatKeypress = handleChatKeypress;
    </script>
</body>
</html>
